<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    
    <!-- ANPASSUNG: viewport-fit=cover für korrekte Nutzung der Safe Area auf iOS/PWA-Geräten -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1, maximum-scale=1, viewport-fit=cover">
    
    <!-- ============= PWA-ERGÄNZUNGEN START ============= -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <!-- Für iOS-Geräte -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lese-Trainer">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <!-- ============= PWA-ERGÄNZUNGEN ENDE ============= -->

    <title>Interaktiver Lese-Trainer</title>
    <style>
        /* ANPASSUNG: touch-action: none; hier entfernt, da es jetzt konditionell im Body gesetzt wird */
        html, body { height: 100%; margin: 0; padding: 0; } 
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f0f2f5; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            box-sizing: border-box; 
            /* ANPASSUNG: Safe Area Padding und ursprüngliche 20px hinzufügen */
            padding-top: calc(20px + env(safe-area-inset-top, 0px));
            padding-right: calc(20px + env(safe-area-inset-right, 0px));
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
            padding-left: calc(20px + env(safe-area-inset-left, 0px));
        }

        /* NEUE REGELN FÜR KONDITIONELLES SCROLLEN */
        body.start-view-active {
            align-items: flex-start; 
            overflow-y: auto;
            touch-action: pan-y;
        }
        body.game-view-active, body.finish-view-active {
            align-items: center;
            overflow: hidden;
            touch-action: none;
        }
        /* ENDE NEUE REGELN */

        #app-container { background-color: #ffffff; padding: 25px 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 700px; text-align: center; transition: max-width 0.3s ease, min-height 0.3s ease; }
        body.fullscreen-mode { padding: 0; }
        #app-container.two-player-mode { max-width: 100%; height: 100%; border-radius: 0; box-shadow: none; display: flex; flex-direction: column; }
        h1, h2, h3 { color: #333; }
        .view { display: none; }
        .view.active { display: block; }
        #game-view.active { display: flex; flex-direction: column; flex-grow: 1; }
        .list-item { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px 20px; margin-bottom: 12px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; text-align: left; }
        .list-item:hover { background-color: #e9ecef; border-color: #ced4da; }
        .list-item h3 { margin: 0 0 5px 0; color: #007bff; }
        .list-item p { margin: 0; color: #6c757d; font-size: 0.9rem; }
        #loading-indicator { font-style: italic; color: #666; }
        button { padding: 12px 20px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; background-color: #007bff; color: white; transition: background-color 0.2s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #e0e0e0; cursor: not-allowed; color: #999; }
        .menu-button { background-color: #6c757d; margin-top: 0; }
        .single-player-game { text-align: center; }
        #progress-indicator { font-size: 0.9rem; color: #777; margin-bottom: 20px; }
        #current-reconstruction { min-height: 50px; border: 2px dashed #d0d0d0; border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 1.2rem; color: #333; font-weight: bold; letter-spacing: 1px; background-color: #fafafa; }
        #word-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        #feedback-message { margin-top: 15px; font-weight: bold; min-height: 24px; }
        #feedback-message.correct { color: #28a745; }
        #feedback-message.incorrect { color: #dc3545; }
        .word-button { background-color: #6c757d; }
        .word-button:hover:not(:disabled) { background-color: #5a6268; }
        #play-audio-button { background-color: #17a2b8; }
        #next-sentence-button { background-color: #28a745; display: none; }
        .settings-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; text-align: left; }
        #two-player-container { display: flex; flex-direction: column; width: 100%; flex-grow: 1; }
        .player-area { border: 2px solid #007bff; border-radius: 10px; padding: 20px; background-color: #f8f9fa; flex: 1; display: flex; flex-direction: column; justify-content: space-around; box-sizing: border-box; touch-action: none; }
        #player2-area { border-color: #dc3545; transform: rotate(180deg); }
        .player-area h2 { margin-top: 0; }
        .player-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .score { font-size: 1.2rem; }
        .player-area .progress-indicator { margin: 0; }
        .player-area .current-reconstruction { font-size: 1.1rem; min-height: 45px; padding: 12px; border: 2px dashed #d0d0d0; border-radius: 8px; background-color: #fff; }
        .player-area .word-pool { min-height: 80px; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .player-area .feedback-message { min-height: 20px; font-size: 0.9rem; }
        .play-audio-button-player { background-color: #17a2b8; align-self: center; margin-top: 10px; }
        #central-controls { display: flex; justify-content: center; align-items: center; gap: 20px; padding: 10px 0; background-color: #e9ecef; flex-shrink: 0; }
        .game-mode-selection label { display: inline-block; margin: 0 10px; font-size: 1.1rem; cursor: pointer; }
        #rounds-container { margin-top: 15px; display: none; }
        #rounds-container label { margin-right: 10px; }
        #rounds-input { width: 60px; padding: 5px; font-size: 1rem; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #2196F3; }
        input:focus + .slider { box-shadow: 0 0 1px #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        #error-type-selection label { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-size: 0.95rem; color: #444; }
        #error-type-selection input[type="radio"] { margin: 0; }
        #error-frequency-container { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        #error-frequency-slider { width: calc(100% - 70px); margin-right: 10px; vertical-align: middle; }
        #error-frequency-value { font-weight: bold; color: #007bff; display: inline-block; width: 20px; text-align: right; vertical-align: middle; }
    </style>
</head>
<body>

    <div id="app-container">
        <h1>Interaktiver Lese-Trainer</h1>

        <div id="start-view" class="view active">
            <h2>Wähle eine Satzliste zum Üben</h2>
            <div class="settings-section">
                <h3>Spielmodus</h3>
                <div class="game-mode-selection" style="text-align: center;"> <!-- Zentriert die Radio-Buttons -->
                    <label><input type="radio" name="gameMode" value="single" checked> Einzelspieler</label>
                    <label><input type="radio" name="gameMode" value="two-player"> Zwei Spieler</label>
                </div>

                <!-- ================== NEUE FUNKTION START ================== -->
                <div style="margin-top: 15px;">
                    <label class="switch">
                        <input type="checkbox" id="auto-continue-toggle">
                        <span class="slider round"></span>
                    </label>
                    <label for="auto-continue-toggle" style="margin-left: 10px; font-weight: bold; vertical-align: middle;">Automatisch weiter</label>
                </div>
                <!-- ================== NEUE FUNKTION ENDE =================== -->
                
                <div id="rounds-container">
                    <label for="rounds-input">Anzahl der Sätze:</label>
                    <input type="number" id="rounds-input" value="5" min="1" max="50">
                </div>
            </div>
            <div class="settings-section">
                <h3>Zufällige Reihenfolge</h3>
                <label class="switch">
                    <input type="checkbox" id="random-order-toggle" checked>
                    <span class="slider round"></span>
                </label>
                <label for="random-order-toggle" style="margin-left: 10px; font-weight: bold; vertical-align: middle;">Sätze randomisieren</label>
            </div>
            <div class="settings-section">
                <h3>Fehler-Modus (Optional)</h3>
                <label class="switch">
                    <input type="checkbox" id="error-mode-toggle">
                    <span class="slider round"></span>
                </label>
                <label for="error-mode-toggle" style="margin-left: 10px; font-weight: bold; vertical-align: middle;">Fehler aktivieren</label>
                <div id="error-type-selection" style="display: none; margin-top: 15px;">
                    <h4>Fehlerart auswählen:</h4>
                     <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label><input type="radio" name="errorType" value="missingLetter" checked> Buchstabe fehlt</label>
                        <label><input type="radio" name="errorType" value="swappedLetters"> Buchstaben vertauscht</label>
                        <label><input type="radio" name="errorType" value="replacedLetter"> Falscher Buchstabe</label>
                        <label><input type="radio" name="errorType" value="duplicatedLetters"> Doppelte Buchstaben</label>
                        <label><input type="radio" name="errorType" value="phoneticallySimilar"> Phonetisch ähnliche Buchstaben</label>
                        <label><input type="radio" name="errorType" value="capitalization"> Groß-/Kleinschreibung</label>
                    </div>
                    <div id="error-frequency-container">
                        <h4>Fehlerhäufigkeit pro Satz:</h4>
                        <input type="range" id="error-frequency-slider" min="1" max="5" value="1">
                        <span id="error-frequency-value">1</span> Fehler
                    </div>
                </div>
            </div>
            <div id="list-selection-container" class="settings-section">
                <p id="loading-indicator">Lade Listen...</p>
            </div>
        </div>

        <div id="game-view" class="view"></div>
        <div id="finish-view" class="view"></div>
    </div>

<script>
    const appContainer = document.getElementById('app-container');
    const mainTitle = document.querySelector('#app-container > h1');
    const startView = document.getElementById('start-view');
    const gameView = document.getElementById('game-view');
    const finishView = document.getElementById('finish-view');
    const listSelectionContainer = document.getElementById('list-selection-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    const gameModeRadios = document.querySelectorAll('input[name="gameMode"]');
    const roundsContainer = document.getElementById('rounds-container');
    const roundsInput = document.getElementById('rounds-input');
    const randomOrderToggle = document.getElementById('random-order-toggle');
    const errorModeToggle = document.getElementById('error-mode-toggle');
    const errorTypeSelection = document.getElementById('error-type-selection');
    const errorFrequencySlider = document.getElementById('error-frequency-slider');
    const errorFrequencyValueSpan = document.getElementById('error-frequency-value');
    
    // ================== NEUE FUNKTION START ==================
    const autoContinueToggle = document.getElementById('auto-continue-toggle');
    // ================== NEUE FUNKTION ENDE ===================

    let allSentences = [];
    let currentSentenceIndex = 0;
    let originalWords = [];
    let reconstructedWords = [];
    let germanVoice = null;
    let gameMode = 'single';
    let totalRounds = 5;
    let randomOrderEnabled = true;
    let errorModeEnabled = false;
    let selectedErrorType = 'missingLetter';
    let selectedErrorFrequency = 1;
    let player1, player2;
    let roundOver = false;

    // ================== NEUE FUNKTION START ==================
    let autoContinueEnabled = false;
    // ================== NEUE FUNKTION ENDE ===================

    document.addEventListener('DOMContentLoaded', () => {
        loadMasterList();
        setupEventListeners();
        errorFrequencyValueSpan.textContent = errorFrequencySlider.value;
        showView(startView); 
    });

    function setupEventListeners() {
        gameModeRadios.forEach(radio => radio.addEventListener('change', (e) => {
            gameMode = e.target.value;
            roundsContainer.style.display = gameMode === 'two-player' ? 'block' : 'none';
        }));
        randomOrderToggle.addEventListener('change', () => randomOrderEnabled = randomOrderToggle.checked);
        errorModeToggle.addEventListener('change', () => {
            errorModeEnabled = errorModeToggle.checked;
            errorTypeSelection.style.display = errorModeEnabled ? 'block' : 'none';
        });
        document.querySelectorAll('input[name="errorType"]').forEach(radio => radio.addEventListener('change', (e) => selectedErrorType = e.target.value));
        errorFrequencySlider.addEventListener('input', (e) => {
            selectedErrorFrequency = parseInt(e.target.value, 10);
            errorFrequencyValueSpan.textContent = selectedErrorFrequency;
        });
        // ================== NEUE FUNKTION START ==================
        autoContinueToggle.addEventListener('change', () => autoContinueEnabled = autoContinueToggle.checked);
        // ================== NEUE FUNKTION ENDE ===================
    }

    function showView(viewToShow) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        viewToShow.classList.add('active');
        mainTitle.style.display = (viewToShow.id === 'start-view') ? 'block' : 'none';
        
        document.body.classList.remove('start-view-active', 'game-view-active', 'finish-view-active');

        if (viewToShow.id === 'start-view') {
            document.body.classList.add('start-view-active');
        } else if (viewToShow.id === 'game-view') {
            document.body.classList.add('game-view-active');
        } else if (viewToShow.id === 'finish-view') {
            document.body.classList.add('finish-view-active');
        }
    }

    function showStartView() {
        document.body.classList.remove('fullscreen-mode');
        appContainer.classList.remove('two-player-mode');
        gameMode = 'single';
        document.querySelector('input[name="gameMode"][value="single"]').checked = true;
        roundsContainer.style.display = 'none';
        randomOrderToggle.checked = true;
        randomOrderEnabled = true;
        errorModeToggle.checked = false;
        errorModeEnabled = false;
        errorTypeSelection.style.display = 'none';
        
        // ================== NEUE FUNKTION START ==================
        // Setzt den Schalter beim Zurückkehren zum Menü zurück
        autoContinueToggle.checked = false;
        autoContinueEnabled = false;
        // ================== NEUE FUNKTION ENDE ===================

        allSentences = [];
        currentSentenceIndex = 0;
        showView(startView);
    }
    
    async function loadMasterList() {
        try {
            const response = await fetch('master.json');
            if (!response.ok) throw new Error('Netzwerkfehler');
            const data = await response.json();
            populateListSelection(data.lists);
        } catch (error) {
            loadingIndicator.textContent = 'Fehler beim Laden der Satzlisten.';
        }
    }

    function populateListSelection(lists) {
        listSelectionContainer.innerHTML = '<h3>Wähle eine Liste</h3>';
        lists.forEach(list => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `<h4>${list.title}</h4><p>${list.description}</p>`;
            item.addEventListener('click', async () => {
                try {
                    const response = await fetch(list.file);
                    if (!response.ok) throw new Error(`Datei nicht gefunden.`);
                    const sentenceData = await response.json();
                    startGame(sentenceData.sentences);
                } catch (error) {
                    alert(`Fehler: ${error.message}`);
                }
            });
            listSelectionContainer.appendChild(item);
        });
        loadingIndicator.style.display = 'none';
    }

    function startGame(sentences) {
        if (!sentences || sentences.length === 0) {
            alert('Diese Liste enthält keine Sätze.');
            return;
        }
        allSentences = randomOrderEnabled ? shuffleArray([...sentences]) : sentences;
        currentSentenceIndex = 0;

        if (gameMode === 'single') {
            document.body.classList.remove('fullscreen-mode');
            startSinglePlayerGame();
        } else {
            document.body.classList.add('fullscreen-mode');
            totalRounds = Math.min(parseInt(roundsInput.value, 10), allSentences.length);
            if (totalRounds < 1) {
                alert("Bitte eine gültige Rundenanzahl eingeben.");
                return;
            }
            allSentences = allSentences.slice(0, totalRounds);
            startTwoPlayerGame();
        }
    }

    function startSinglePlayerGame() {
        appContainer.classList.remove('two-player-mode');
        gameView.innerHTML = `<div class="single-player-game"><div id="progress-indicator"></div><p>Höre gut zu und baue den Satz nach.</p><div id="current-reconstruction">&nbsp;</div><div id="word-pool"></div><div id="feedback-message"></div><button id="play-audio-button">Satz vorlesen</button><button id="next-sentence-button">Nächster Satz</button><br><button id="back-to-menu-button-game" class="menu-button">Zurück zum Menü</button></div>`;
        document.getElementById('play-audio-button').addEventListener('click', playCurrentSentence);
        document.getElementById('next-sentence-button').addEventListener('click', loadNextSinglePlayerSentence);
        document.getElementById('back-to-menu-button-game').addEventListener('click', showStartView);
        showView(gameView);
        loadSinglePlayerSentence(0);
    }

    function loadSinglePlayerSentence(index) {
        if (index >= allSentences.length) { showSinglePlayerFinishView(); return; }
        const currentReconstruction = document.getElementById('current-reconstruction');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextSentenceButton = document.getElementById('next-sentence-button');
        reconstructedWords = [];
        feedbackMessage.textContent = '';
        feedbackMessage.className = '';
        nextSentenceButton.style.display = 'none';
        currentReconstruction.textContent = '\u00A0';
        document.getElementById('progress-indicator').textContent = `Satz ${index + 1} von ${allSentences.length}`;
        const currentSentence = allSentences[index];
        originalWords = currentSentence.replace(/[.,!?;]$/, '').split(' ');
        let wordsForPool = generateWordPool(originalWords);
        displayWords(shuffleArray(wordsForPool), document.getElementById('word-pool'));
        playCurrentSentence();
    }
    
    function handleSinglePlayerWordClick(word, button) {
        button.disabled = true;
        reconstructedWords.push(word);
        document.getElementById('current-reconstruction').textContent = reconstructedWords.join(' ');
        checkSinglePlayerSentence();
    }

    function checkSinglePlayerSentence() {
        const feedbackMessage = document.getElementById('feedback-message');
        const reconstructed = reconstructedWords.join(' ');
        const original = originalWords.slice(0, reconstructedWords.length).join(' ');
        if (reconstructed !== original) {
            feedbackMessage.textContent = 'Das war nicht richtig. Versuch es nochmal!';
            feedbackMessage.className = 'incorrect';
            setTimeout(() => {
                reconstructedWords = [];
                document.getElementById('current-reconstruction').textContent = '\u00A0';
                feedbackMessage.textContent = '';
                document.querySelectorAll('#word-pool .word-button').forEach(btn => btn.disabled = false);
            }, 1500);
        } else if (reconstructedWords.length === originalWords.length) {
            feedbackMessage.textContent = 'Super, das ist richtig!';
            feedbackMessage.className = 'correct';
            document.querySelectorAll('#word-pool .word-button').forEach(btn => btn.disabled = true);

            // ================== NEUE FUNKTION START ==================
            if (autoContinueEnabled) {
                // Bei Aktivierung automatisch nach 2 Sekunden fortfahren
                setTimeout(loadNextSinglePlayerSentence, 2000);
            } else {
                // Andernfalls den Button anzeigen
                document.getElementById('next-sentence-button').style.display = 'inline-block';
            }
            // ================== NEUE FUNKTION ENDE ===================
        }
    }

    function loadNextSinglePlayerSentence() {
        currentSentenceIndex++;
        loadSinglePlayerSentence(currentSentenceIndex);
    }

    function showSinglePlayerFinishView() {
        finishView.innerHTML = `<h2>Großartig!</h2><p>Du hast alle Sätze erfolgreich geübt.</p><button id="restart-button">Dieselbe Liste nochmal</button><button id="back-to-menu-button-finish" class="menu-button">Andere Liste wählen</button>`;
        document.getElementById('restart-button').addEventListener('click', () => startGame(allSentences));
        document.getElementById('back-to-menu-button-finish').addEventListener('click', showStartView);
        showView(finishView);
    }

    function startTwoPlayerGame() {
        appContainer.classList.add('two-player-mode');
        gameView.innerHTML = `<div id="two-player-container"><div id="player2-area" class="player-area"><div class="player-header"><h2>Spieler 2</h2><div id="p2-score" class="score">Punkte: 0</div></div><div id="p2-progress" class="progress-indicator"></div><div id="p2-reconstruction" class="current-reconstruction">&nbsp;</div><div id="p2-word-pool" class="word-pool"></div><button id="p2-play-audio-button" class="play-audio-button-player">Satz vorlesen</button><div id="p2-feedback" class="feedback-message"></div></div><div id="central-controls"><button id="next-sentence-button" style="display:none;">Nächster Satz</button><button id="end-game-button" class="menu-button">Spiel beenden</button></div><div id="player1-area" class="player-area"><div class="player-header"><h2>Spieler 1</h2><div id="p1-score" class="score">Punkte: 0</div></div><div id="p1-progress" class="progress-indicator"></div><div id="p1-reconstruction" class="current-reconstruction">&nbsp;</div><div id="p1-word-pool" class="word-pool"></div><button id="p1-play-audio-button" class="play-audio-button-player">Satz vorlesen</button><div id="p1-feedback" class="feedback-message"></div></div></div>`;
        player1 = { id: 1, score: 0, reconstructedWords: [], scoreEl: document.getElementById('p1-score'), progressEl: document.getElementById('p1-progress'), reconstructionEl: document.getElementById('p1-reconstruction'), wordPoolEl: document.getElementById('p1-word-pool'), feedbackEl: document.getElementById('p1-feedback') };
        player2 = { id: 2, score: 0, reconstructedWords: [], scoreEl: document.getElementById('p2-score'), progressEl: document.getElementById('p2-progress'), reconstructionEl: document.getElementById('p2-reconstruction'), wordPoolEl: document.getElementById('p2-word-pool'), feedbackEl: document.getElementById('p2-feedback') };
        document.getElementById('p1-play-audio-button').addEventListener('click', playCurrentSentence);
        document.getElementById('p2-play-audio-button').addEventListener('click', playCurrentSentence);
        document.getElementById('next-sentence-button').addEventListener('click', loadNextTwoPlayerSentence);
        document.getElementById('end-game-button').addEventListener('click', showStartView);
        showView(gameView);
        loadTwoPlayerSentence(0);
    }
    
    function loadTwoPlayerSentence(index) {
        if (index >= allSentences.length) { showTwoPlayerFinishView(); return; }
        roundOver = false;
        document.getElementById('next-sentence-button').style.display = 'none';
        [player1, player2].forEach(p => {
            p.reconstructedWords = [];
            p.reconstructionEl.textContent = '\u00A0';
            p.feedbackEl.textContent = '';
            p.progressEl.textContent = `Satz ${index + 1} von ${allSentences.length}`;
        });
        const currentSentence = allSentences[index];
        originalWords = currentSentence.replace(/[.,!?;]$/, '').split(' ');
        const wordsForPool = generateWordPool(originalWords);
        const shuffledWords = shuffleArray(wordsForPool);
        displayWords(shuffledWords, player1.wordPoolEl, player1);
        displayWords(shuffledWords, player2.wordPoolEl, player2);
        playCurrentSentence();
    }

    function handleTwoPlayerWordClick(word, button, player) {
        if (roundOver) return;

        button.disabled = true;
        
        player.reconstructedWords.push(word);
        player.reconstructionEl.textContent = player.reconstructedWords.join(' ');
        
        checkTwoPlayerSentence(player);
    }

    function checkTwoPlayerSentence(player) {
        if (roundOver) return;

        const reconstructed = player.reconstructedWords.join(' ');
        const original = originalWords.slice(0, player.reconstructedWords.length).join(' ');

        if (reconstructed !== original) {
            player.feedbackEl.textContent = 'Falsch!';
            player.feedbackEl.className = 'feedback-message incorrect';
            
            const playerButtons = player.wordPoolEl.querySelectorAll('.word-button');

            setTimeout(() => {
                if (!roundOver) { 
                    player.reconstructedWords = [];
                    player.reconstructionEl.textContent = '\u00A0';
                    player.feedbackEl.textContent = '';
                    playerButtons.forEach(btn => btn.disabled = false);
                }
            }, 1000);

        } else if (player.reconstructedWords.length === originalWords.length) {
            roundOver = true; 
            
            const winner = player;
            const loser = (player.id === 1) ? player2 : player1;
            const roundPoints = originalWords.length;
            
            winner.score += roundPoints;
            winner.scoreEl.textContent = `Punkte: ${winner.score}`;
            winner.feedbackEl.textContent = `Runde gewonnen! +${roundPoints} Punkte`;
            winner.feedbackEl.className = 'feedback-message correct';

            let loserPoints = 0;
            for (let i = 0; i < loser.reconstructedWords.length; i++) {
                if (loser.reconstructedWords[i] === originalWords[i]) {
                    loserPoints++;
                }
            }
            loser.score += loserPoints;
            loser.scoreEl.textContent = `Punkte: ${loser.score}`;
            loser.feedbackEl.textContent = `+${loserPoints} Punkte für richtige Wörter`;
            loser.feedbackEl.className = 'feedback-message';

            document.querySelectorAll('.word-button').forEach(btn => btn.disabled = true);
            
            // ================== NEUE FUNKTION START ==================
            if (autoContinueEnabled) {
                // Bei Aktivierung automatisch nach 3 Sekunden fortfahren (etwas länger für zwei Spieler)
                setTimeout(loadNextTwoPlayerSentence, 3000);
            } else {
                // Andernfalls den Button anzeigen
                document.getElementById('next-sentence-button').style.display = 'inline-block';
            }
            // ================== NEUE FUNKTION ENDE ===================
        }
    }

    function loadNextTwoPlayerSentence() {
        currentSentenceIndex++;
        lo
