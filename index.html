<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ============= PWA-ERGÄNZUNGEN START ============= -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <!-- Für iOS-Geräte -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lese-Trainer">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <!-- ============= PWA-ERGÄNZUNGEN ENDE ============= -->

    <title>Interaktiver Lese-Trainer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        #app-container { background-color: #ffffff; padding: 25px 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 700px; text-align: center; transition: max-width 0.3s ease, min-height 0.3s ease; }
        
        #app-container.two-player-mode {
            max-width: 900px;
            min-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3 { color: #333; }
        .view { display: none; }
        .view.active { display: block; }

        #game-view.active {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .list-item { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px 20px; margin-bottom: 12px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; text-align: left; }
        .list-item:hover { background-color: #e9ecef; border-color: #ced4da; }
        .list-item h3 { margin: 0 0 5px 0; color: #007bff; }
        .list-item p { margin: 0; color: #6c757d; font-size: 0.9rem; }
        #loading-indicator { font-style: italic; color: #666; }
        button { padding: 12px 20px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; background-color: #007bff; color: white; transition: background-color 0.2s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #e0e0e0; cursor: not-allowed; color: #999; }
        .menu-button { background-color: #6c757d; margin-top: 20px; }
        
        /* Einzelspieler-Layout */
        .single-player-game { text-align: center; }
        #progress-indicator { font-size: 0.9rem; color: #777; margin-bottom: 20px; }
        #current-reconstruction { min-height: 50px; border: 2px dashed #d0d0d0; border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 1.2rem; color: #333; font-weight: bold; letter-spacing: 1px; background-color: #fafafa; }
        #word-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        #feedback-message { margin-top: 15px; font-weight: bold; min-height: 24px; }
        #feedback-message.correct { color: #28a745; }
        #feedback-message.incorrect { color: #dc3545; }
        .word-button { background-color: #6c757d; }
        .word-button:hover:not(:disabled) { background-color: #5a6268; }
        #play-audio-button { background-color: #17a2b8; }
        #next-sentence-button { background-color: #28a745; display: none; }
        .settings-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; text-align: left; }

        /* ========= KORRIGIERTES CSS FÜR ZWEI-SPIELER-MODUS ========= */
        #two-player-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            flex-grow: 1;
        }
        
        .player-area {
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            background-color: #f8f9fa;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly; /* NEU: Verteilt den Inhalt gleichmäßig! */
        }
        
        #player2-area {
            border-color: #dc3545;
            transform: rotate(180deg);
        }
        
        .player-area h2 { margin-top: 0; }
        .player-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 10px; }
        .score { font-size: 1.2rem; }
        .player-area .progress-indicator { margin: 0; }
        .player-area .current-reconstruction { font-size: 1.1rem; min-height: 45px; padding: 12px; border: 2px dashed #d0d0d0; border-radius: 8px; background-color: #fff; }
        
        .player-area .word-pool {
            min-height: 80px;
            /* flex-grow wurde entfernt */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .player-area .feedback-message { min-height: 20px; font-size: 0.9rem; }
        #two-player-controls { margin-top: 15px; text-align: center; }

        /* ========= CSS FÜR SPIELMODUS-AUSWAHL ========= */
        .game-mode-selection label { display: inline-block; margin: 0 10px; font-size: 1.1rem; cursor: pointer; }
        #rounds-container { margin-top: 15px; display: none; }
        #rounds-container label { margin-right: 10px; }
        #rounds-input { width: 60px; padding: 5px; font-size: 1rem; }

        /* Vorhandene CSS-Stile für Schalter, Slider etc. (unverändert) */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #2196F3; }
        input:focus + .slider { box-shadow: 0 0 1px #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        #error-type-selection label { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-size: 0.95rem; color: #444; }
        #error-type-selection input[type="radio"] { margin: 0; }
        #error-frequency-container { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        #error-frequency-slider { width: calc(100% - 70px); margin-right: 10px; vertical-align: middle; }
        #error-frequency-value { font-weight: bold; color: #007bff; display: inline-block; width: 20px; text-align: right; vertical-align: middle; }
    </style>
</head>
<body>

    <div id="app-container">
        <h1>Interaktiver Lese-Trainer</h1>

        <!-- Start-Ansicht -->
        <div id="start-view" class="view active">
            <h2>Wähle eine Satzliste zum Üben</h2>

            <!-- NEU: SPIELMODUS-AUSWAHL -->
            <div class="settings-section">
                <h3>Spielmodus</h3>
                <div class="game-mode-selection">
                    <label>
                        <input type="radio" name="gameMode" value="single" checked> Einzelspieler
                    </label>
                    <label>
                        <input type="radio" name="gameMode" value="two-player"> Zwei Spieler
                    </label>
                </div>
                <div id="rounds-container">
                    <label for="rounds-input">Anzahl der Sätze:</label>
                    <input type="number" id="rounds-input" value="5" min="1" max="50">
                </div>
            </div>

            <!-- Zufällige Reihenfolge -->
            <div class="settings-section">
                <h3>Zufällige Reihenfolge</h3>
                <label class="switch">
                    <input type="checkbox" id="random-order-toggle" checked>
                    <span class="slider round"></span>
                </label>
                <label for="random-order-toggle" style="margin-left: 10px; font-weight: bold; vertical-align: middle;">Sätze randomisieren</label>
            </div>
            
            <!-- Fehler-Modus -->
            <div class="settings-section">
                <h3>Fehler-Modus (Optional)</h3>
                <label class="switch">
                    <input type="checkbox" id="error-mode-toggle">
                    <span class="slider round"></span>
                </label>
                <label for="error-mode-toggle" style="margin-left: 10px; font-weight: bold; vertical-align: middle;">Fehler aktivieren</label>

                <div id="error-type-selection" style="display: none; margin-top: 15px;">
                    <h4>Fehlerart auswählen:</h4>
                     <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label><input type="radio" name="errorType" value="missingLetter" checked> Buchstabe fehlt</label>
                        <label><input type="radio" name="errorType" value="swappedLetters"> Buchstaben vertauscht</label>
                        <label><input type="radio" name="errorType" value="replacedLetter"> Falscher Buchstabe</label>
                        <label><input type="radio" name="errorType" value="duplicatedLetters"> Doppelte Buchstaben</label>
                        <label><input type="radio" name="errorType" value="phoneticallySimilar"> Phonetisch ähnliche Buchstaben</label>
                        <label><input type="radio" name="errorType" value="capitalization"> Groß-/Kleinschreibung</label>
                    </div>
                    <div id="error-frequency-container">
                        <h4>Fehlerhäufigkeit pro Satz:</h4>
                        <input type="range" id="error-frequency-slider" min="1" max="5" value="1">
                        <span id="error-frequency-value">1</span> Fehler
                    </div>
                </div>
            </div>

            <!-- Listenauswahl -->
            <div id="list-selection-container" class="settings-section">
                <p id="loading-indicator">Lade Listen...</p>
            </div>
        </div>

        <!-- Spiel-Ansicht (wird dynamisch befüllt) -->
        <div id="game-view" class="view">
            <!-- Inhalt wird per JS generiert, je nach Spielmodus -->
        </div>

        <!-- Finish-Ansicht -->
        <div id="finish-view" class="view">
            <!-- Inhalt wird per JS generiert, je nach Spielmodus -->
        </div>
    </div>

<script>
    // ========= DOM-Elemente =========
    const appContainer = document.getElementById('app-container');
    const mainTitle = document.querySelector('#app-container > h1'); // <-- ÄNDERUNG 1: H1-Element referenzieren
    const startView = document.getElementById('start-view');
    const gameView = document.getElementById('game-view');
    const finishView = document.getElementById('finish-view');
    const listSelectionContainer = document.getElementById('list-selection-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    
    // Einstellungs-Elemente
    const gameModeRadios = document.querySelectorAll('input[name="gameMode"]');
    const roundsContainer = document.getElementById('rounds-container');
    const roundsInput = document.getElementById('rounds-input');
    const randomOrderToggle = document.getElementById('random-order-toggle');
    const errorModeToggle = document.getElementById('error-mode-toggle');
    const errorTypeSelection = document.getElementById('error-type-selection');
    const errorFrequencySlider = document.getElementById('error-frequency-slider');
    const errorFrequencyValueSpan = document.getElementById('error-frequency-value');

    // ========= Globaler Spielzustand =========
    let allSentences = [];
    let currentSentenceIndex = 0;
    let originalWords = [];
    let reconstructedWords = [];
    let germanVoice = null;

    // Einstellungen
    let gameMode = 'single'; // 'single' oder 'two-player'
    let totalRounds = 5;
    let randomOrderEnabled = true;
    let errorModeEnabled = false;
    let selectedErrorType = 'missingLetter';
    let selectedErrorFrequency = 1;

    // Zwei-Spieler-Zustand
    let player1, player2;
    let roundOver = false;

    // ========= Initialisierung & Navigation =========
    document.addEventListener('DOMContentLoaded', () => {
        loadMasterList();
        setupEventListeners();
        // Initialen Wert für den Slider anzeigen
        errorFrequencyValueSpan.textContent = errorFrequencySlider.value;
    });

    function setupEventListeners() {
        gameModeRadios.forEach(radio => radio.addEventListener('change', (e) => {
            gameMode = e.target.value;
            roundsContainer.style.display = gameMode === 'two-player' ? 'block' : 'none';
        }));
        randomOrderToggle.addEventListener('change', () => randomOrderEnabled = randomOrderToggle.checked);
        errorModeToggle.addEventListener('change', () => {
            errorModeEnabled = errorModeToggle.checked;
            errorTypeSelection.style.display = errorModeEnabled ? 'block' : 'none';
        });
        document.querySelectorAll('input[name="errorType"]').forEach(radio => radio.addEventListener('change', (e) => selectedErrorType = e.target.value));
        errorFrequencySlider.addEventListener('input', (e) => {
            selectedErrorFrequency = parseInt(e.target.value, 10);
            errorFrequencyValueSpan.textContent = selectedErrorFrequency;
        });
    }

    function showView(viewToShow) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        viewToShow.classList.add('active');

        // <-- ÄNDERUNG 2: Titel nur auf der Startseite anzeigen
        mainTitle.style.display = (viewToShow.id === 'start-view') ? 'block' : 'none';
    }

    function showStartView() {
        appContainer.classList.remove('two-player-mode');
        // Alle UI-Elemente und Zustände zurücksetzen
        gameMode = 'single';
        document.querySelector('input[name="gameMode"][value="single"]').checked = true;
        roundsContainer.style.display = 'none';
        randomOrderToggle.checked = true;
        randomOrderEnabled = true;
        errorModeToggle.checked = false;
        errorModeEnabled = false;
        errorTypeSelection.style.display = 'none';
        
        allSentences = [];
        currentSentenceIndex = 0;
        showView(startView);
    }
    
    // ========= Laden der Daten =========
    async function loadMasterList() {
        try {
            const response = await fetch('master.json');
            if (!response.ok) throw new Error('Netzwerkfehler');
            const data = await response.json();
            populateListSelection(data.lists);
        } catch (error) {
            loadingIndicator.textContent = 'Fehler beim Laden der Satzlisten.';
        }
    }

    function populateListSelection(lists) {
        listSelectionContainer.innerHTML = ''; // Vorherigen Inhalt löschen
        lists.forEach(list => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `<h3>${list.title}</h3><p>${list.description}</p>`;
            item.addEventListener('click', async () => {
                try {
                    const response = await fetch(list.file);
                    if (!response.ok) throw new Error(`Datei nicht gefunden.`);
                    const sentenceData = await response.json();
                    startGame(sentenceData.sentences);
                } catch (error) {
                    alert(`Fehler: ${error.message}`);
                }
            });
            listSelectionContainer.appendChild(item);
        });
        loadingIndicator.style.display = 'none';
    }

    // ========= Spielstart-Router =========
    function startGame(sentences) {
        if (!sentences || sentences.length === 0) {
            alert('Diese Liste enthält keine Sätze.');
            return;
        }

        allSentences = randomOrderEnabled ? shuffleArray([...sentences]) : sentences;
        currentSentenceIndex = 0;

        if (gameMode === 'single') {
            startSinglePlayerGame();
        } else {
            totalRounds = Math.min(parseInt(roundsInput.value, 10), allSentences.length);
            if (totalRounds < 1) {
                alert("Bitte eine gültige Rundenanzahl eingeben.");
                return;
            }
            allSentences = allSentences.slice(0, totalRounds); // Sätze auf Rundenanzahl kürzen
            startTwoPlayerGame();
        }
    }

    // ========= Einzelspieler-Modus =========
    function startSinglePlayerGame() {
        appContainer.classList.remove('two-player-mode');
        gameView.innerHTML = `
            <div class="single-player-game">
                <div id="progress-indicator"></div>
                <p>Höre gut zu und baue den Satz nach.</p>
                <div id="current-reconstruction">&nbsp;</div>
                <div id="word-pool"></div>
                <div id="feedback-message"></div>
                <button id="play-audio-button">Satz vorlesen</button>
                <button id="next-sentence-button">Nächster Satz</button>
                <br>
                <button id="back-to-menu-button-game" class="menu-button">Zurück zum Menü</button>
            </div>`;
        
        // Event-Listener für die neu erstellten Knöpfe
        document.getElementById('play-audio-button').addEventListener('click', playCurrentSentence);
        document.getElementById('next-sentence-button').addEventListener('click', loadNextSinglePlayerSentence);
        document.getElementById('back-to-menu-button-game').addEventListener('click', showStartView);

        showView(gameView);
        loadSinglePlayerSentence(0);
    }

    function loadSinglePlayerSentence(index) {
        if (index >= allSentences.length) {
            showSinglePlayerFinishView();
            return;
        }

        const currentReconstruction = document.getElementById('current-reconstruction');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextSentenceButton = document.getElementById('next-sentence-button');

        reconstructedWords = [];
        feedbackMessage.textContent = '';
        feedbackMessage.className = '';
        nextSentenceButton.style.display = 'none';
        currentReconstruction.textContent = '\u00A0';
        document.getElementById('progress-indicator').textContent = `Satz ${index + 1} von ${allSentences.length}`;

        const currentSentence = allSentences[index];
        originalWords = currentSentence.replace(/[.,!?;]$/, '').split(' ');

        let wordsForPool = generateWordPool(originalWords);
        displayWords(shuffleArray(wordsForPool), document.getElementById('word-pool'));
        playCurrentSentence();
    }

    function handleSinglePlayerWordClick(word, button) {
        button.disabled = true;
        reconstructedWords.push(word);
        document.getElementById('current-reconstruction').textContent = reconstructedWords.join(' ');
        checkSinglePlayerSentence();
    }
    
    function checkSinglePlayerSentence() {
        const feedbackMessage = document.getElementById('feedback-message');
        const reconstructed = reconstructedWords.join(' ');
        const original = originalWords.slice(0, reconstructedWords.length).join(' ');

        if (reconstructed !== original) {
            feedbackMessage.textContent = 'Das war nicht richtig. Versuch es nochmal!';
            feedbackMessage.className = 'incorrect';
            setTimeout(() => {
                reconstructedWords = [];
                document.getElementById('current-reconstruction').textContent = '\u00A0';
                feedbackMessage.textContent = '';
                document.querySelectorAll('#word-pool .word-button').forEach(btn => btn.disabled = false);
            }, 1500);
        } else if (reconstructedWords.length === originalWords.length) {
            feedbackMessage.textContent = 'Super, das ist richtig!';
            feedbackMessage.className = 'correct';
            document.getElementById('next-sentence-button').style.display = 'inline-block';
        }
    }

    function loadNextSinglePlayerSentence() {
        currentSentenceIndex++;
        loadSinglePlayerSentence(currentSentenceIndex);
    }

    function showSinglePlayerFinishView() {
        finishView.innerHTML = `
            <h2>Großartig!</h2>
            <p>Du hast alle Sätze erfolgreich geübt.</p>
            <button id="restart-button">Dieselbe Liste nochmal</button>
            <button id="back-to-menu-button-finish" class="menu-button">Andere Liste wählen</button>
        `;
        document.getElementById('restart-button').addEventListener('click', () => startGame(allSentences));
        document.getElementById('back-to-menu-button-finish').addEventListener('click', showStartView);
        showView(finishView);
    }

    // ========= Zwei-Spieler-Modus =========
    function startTwoPlayerGame() {
        appContainer.classList.add('two-player-mode');
        gameView.innerHTML = `
            <div id="two-player-container">
                <!-- HIER DIE ÄNDERUNG: Spieler 2 ist jetzt oben -->
                <div id="player2-area" class="player-area">
                     <div class="player-header">
                        <h2>Spieler 2</h2>
                        <div id="p2-score" class="score">Punkte: 0</div>
                    </div>
                    <div id="p2-progress" class="progress-indicator"></div>
                    <div id="p2-reconstruction" class="current-reconstruction">&nbsp;</div>
                    <div id="p2-word-pool" class="word-pool"></div>
                    <div id="p2-feedback" class="feedback-message"></div>
                </div>
                <!-- Spieler 1 ist jetzt unten -->
                <div id="player1-area" class="player-area">
                    <div class="player-header">
                        <h2>Spieler 1</h2>
                        <div id="p1-score" class="score">Punkte: 0</div>
                    </div>
                    <div id="p1-progress" class="progress-indicator"></div>
                    <div id="p1-reconstruction" class="current-reconstruction">&nbsp;</div>
                    <div id="p1-word-pool" class="word-pool"></div>
                    <div id="p1-feedback" class="feedback-message"></div>
                </div>
            </div>
            <div id="two-player-controls">
                <button id="play-audio-button">Satz vorlesen</button>
                <button id="next-sentence-button" style="display:none;">Nächster Satz</button>
                <button id="back-to-menu-button-game" class="menu-button">Spiel beenden</button>
            </div>`;
        
        // Spieler-Objekte initialisieren
        player1 = {
            id: 1,
            score: 0,
            reconstructedWords: [],
            scoreEl: document.getElementById('p1-score'),
            progressEl: document.getElementById('p1-progress'),
            reconstructionEl: document.getElementById('p1-reconstruction'),
            wordPoolEl: document.getElementById('p1-word-pool'),
            feedbackEl: document.getElementById('p1-feedback')
        };
        player2 = {
            id: 2,
            score: 0,
            reconstructedWords: [],
            scoreEl: document.getElementById('p2-score'),
            progressEl: document.getElementById('p2-progress'),
            reconstructionEl: document.getElementById('p2-reconstruction'),
            wordPoolEl: document.getElementById('p2-word-pool'),
            feedbackEl: document.getElementById('p2-feedback')
        };
        
        // Event-Listener
        document.getElementById('play-audio-button').addEventListener('click', playCurrentSentence);
        document.getElementById('next-sentence-button').addEventListener('click', loadNextTwoPlayerSentence);
        document.getElementById('back-to-menu-button-game').addEventListener('click', showStartView);

        showView(gameView);
        loadTwoPlayerSentence(0);
    }
    
    function loadTwoPlayerSentence(index) {
        if (index >= allSentences.length) {
            showTwoPlayerFinishView();
            return;
        }
        
        roundOver = false;
        document.getElementById('next-sentence-button').style.display = 'none';

        [player1, player2].forEach(p => {
            p.reconstructedWords = [];
            p.reconstructionEl.textContent = '\u00A0';
            p.feedbackEl.textContent = '';
            p.progressEl.textContent = `Satz ${index + 1} von ${allSentences.length}`;
        });
        
        const currentSentence = allSentences[index];
        originalWords = currentSentence.replace(/[.,!?;]$/, '').split(' ');
        
        const wordsForPool = generateWordPool(originalWords);
        const shuffledWords = shuffleArray(wordsForPool);

        displayWords(shuffledWords, player1.wordPoolEl, player1);
        displayWords(shuffledWords, player2.wordPoolEl, player2);

        playCurrentSentence();
    }

    function handleTwoPlayerWordClick(word, button, player) {
        if (roundOver) return;
        
        button.disabled = true;
        player.reconstructedWords.push(word);
        player.reconstructionEl.textContent = player.reconstructedWords.join(' ');
        checkTwoPlayerSentence(player);
    }

    function checkTwoPlayerSentence(player) {
        const reconstructed = player.reconstructedWords.join(' ');
        const original = originalWords.slice(0, player.reconstructedWords.length).join(' ');

        if (reconstructed !== original) {
            player.feedbackEl.textContent = 'Falsch!';
            player.feedbackEl.className = 'feedback-message incorrect';
            setTimeout(() => {
                player.reconstructedWords = [];
                player.reconstructionEl.textContent = '\u00A0';
                player.feedbackEl.textContent = '';
                // Nur die Buttons dieses Spielers wieder aktivieren
                player.wordPoolEl.querySelectorAll('.word-button').forEach(btn => btn.disabled = false);
            }, 1000);
        } else if (player.reconstructedWords.length === originalWords.length) {
            // Dieser Spieler hat die Runde gewonnen!
            roundOver = true;
            const winner = player;
            const loser = (player.id === 1) ? player2 : player1;
            
            // Punkte für Gewinner
            const roundPoints = originalWords.length;
            winner.score += roundPoints;
            winner.scoreEl.textContent = `Punkte: ${winner.score}`;
            winner.feedbackEl.textContent = `Runde gewonnen! +${roundPoints} Punkte`;
            winner.feedbackEl.className = 'feedback-message correct';

            // Punkte für Verlierer berechnen
            let loserPoints = 0;
            for (let i = 0; i < loser.reconstructedWords.length; i++) {
                if (loser.reconstructedWords[i] === originalWords[i]) {
                    loserPoints++;
                }
            }
            loser.score += loserPoints;
            loser.scoreEl.textContent = `Punkte: ${loser.score}`;
            loser.feedbackEl.textContent = `+${loserPoints} Punkte für richtige Wörter`;
            loser.feedbackEl.className = 'feedback-message';

            // Alle Wort-Buttons deaktivieren
            document.querySelectorAll('.word-button').forEach(btn => btn.disabled = true);
            document.getElementById('next-sentence-button').style.display = 'inline-block';
        }
    }
    
    function loadNextTwoPlayerSentence() {
        currentSentenceIndex++;
        loadTwoPlayerSentence(currentSentenceIndex);
    }

    function showTwoPlayerFinishView() {
        let winnerText = '';
        if (player1.score > player2.score) {
            winnerText = 'Spieler 1 hat gewonnen!';
        } else if (player2.score > player1.score) {
            winnerText = 'Spieler 2 hat gewonnen!';
        } else {
            winnerText = 'Unentschieden!';
        }

        finishView.innerHTML = `
            <h2>Spiel beendet!</h2>
            <h3>${winnerText}</h3>
            <p style="font-size: 1.2rem; margin: 10px 0;">Spieler 1: <strong>${player1.score}</strong> Punkte</p>
            <p style="font-size: 1.2rem; margin: 10px 0;">Spieler 2: <strong>${player2.score}</strong> Punkte</p>
            <button id="back-to-menu-button-finish" class="menu-button">Zurück zum Hauptmenü</button>
        `;
        document.getElementById('back-to-menu-button-finish').addEventListener('click', showStartView);
        showView(finishView);
    }


    // ========= Geteilte Hilfsfunktionen =========
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // Angepasst, um ein Ziel-Element und ggf. einen Spieler zu akzeptieren
    function displayWords(words, targetElement, player = null) {
        targetElement.innerHTML = '';
        words.forEach(word => {
            const button = document.createElement('button');
            button.textContent = word;
            button.classList.add('word-button');
            button.addEventListener('click', () => {
                if (gameMode === 'single') {
                    handleSinglePlayerWordClick(word, button);
                } else {
                    handleTwoPlayerWordClick(word, button, player);
                }
            });
            targetElement.appendChild(button);
        });
    }

    function generateWordPool(correctWords) {
        let pool = [...correctWords];
        if (errorModeEnabled) {
            const numWords = correctWords.length;
            const numErrors = Math.min(selectedErrorFrequency, numWords);
            let errorIndices = new Set();
            while (errorIndices.size < numErrors) {
                errorIndices.add(Math.floor(Math.random() * numWords));
            }
            errorIndices.forEach(index => {
                const errorWord = generateError(correctWords[index], selectedErrorType);
                if (errorWord && errorWord !== correctWords[index]) {
                    pool.push(errorWord);
                }
            });
        }
        return pool;
    }

    function generateError(word, errorType) { /* ... Deine existierende generateError Funktion ... */ 
        if (word.length <= 1 && !['capitalization', 'replacedLetter', 'duplicatedLetters'].includes(errorType)) {return word;}
        let modifiedWord = word; let chars = word.split('');
        const preserveCase = (originalChar, newChar) => {if (!originalChar) return newChar; if (originalChar === originalChar.toUpperCase() && originalChar.match(/[A-ZÄÖÜ]/)) { return newChar.toUpperCase(); } return newChar.toLowerCase(); };
        switch (errorType) {
            case 'missingLetter': if (chars.length > 1) { const indexToRemove = Math.floor(Math.random() * chars.length); chars.splice(indexToRemove, 1); modifiedWord = chars.join(''); } break;
            case 'swappedLetters': if (chars.length > 1) { const index1 = Math.floor(Math.random() * (chars.length - 1)); const index2 = index1 + 1; [chars[index1], chars[index2]] = [chars[index2], chars[index1]]; modifiedWord = chars.join(''); } break;
            case 'replacedLetter': if (chars.length > 0) { const indexToReplace = Math.floor(Math.random() * chars.length); const originalChar = chars[indexToReplace].toLowerCase(); const alphabet = 'abcdefghijklmnopqrstuvwxyzäöüß'; let replacementChar = originalChar; while (replacementChar === originalChar) { replacementChar = alphabet[Math.floor(Math.random() * alphabet.length)]; } chars[indexToReplace] = preserveCase(chars[indexToReplace], replacementChar); modifiedWord = chars.join(''); } break;
            case 'duplicatedLetters': if (chars.length > 0) { const indexToDuplicate = Math.floor(Math.random() * chars.length); chars.splice(indexToDuplicate, 0, chars[indexToDuplicate]); modifiedWord = chars.join(''); } break;
            case 'phoneticallySimilar': const subs = {'b':'p','p':'b','d':'t','t':'d','g':'k','k':'g','f':'v','v':'f','s':'z','z':'s'}; let replaced = false; for (let i=0; i<chars.length; i++) { const charLower = chars[i].toLowerCase(); if (subs[charLower]) { chars[i] = preserveCase(chars[i], subs[charLower]); replaced=true; break; } } if(replaced) modifiedWord = chars.join(''); else modifiedWord = generateError(word, 'replacedLetter'); break;
            case 'capitalization': if (chars.length > 0 && chars[0].match(/[A-Za-zÄÖÜäöü]/)) { if (chars[0] === chars[0].toUpperCase()) { chars[0] = chars[0].toLowerCase(); } else { chars[0] = chars[0].toUpperCase(); } modifiedWord = chars.join(''); } break;
        }
        if (modifiedWord === word || modifiedWord === "") { if (word.length > 0 && errorType !== 'replacedLetter') { let fallbackWord = generateError(word, 'replacedLetter'); if (fallbackWord !== word) { return fallbackWord; } } return word; } return modifiedWord;
    }

    // ========= Sprachausgabe =========
    window.speechSynthesis.onvoiceschanged = () => {
        germanVoice = window.speechSynthesis.getVoices().find(v => v.lang === 'de-DE');
    };
    function playCurrentSentence() {
        if ('speechSynthesis' in window && allSentences.length > 0) {
            const utterance = new SpeechSynthesisUtterance(allSentences[currentSentenceIndex]);
            utterance.lang = 'de-DE';
            utterance.rate = 0.9;
            if (germanVoice) utterance.voice = germanVoice;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }
    }
</script>

<!-- ============= PWA-ERGÄNZUNG: SERVICE WORKER REGISTRIERUNG ============= -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('Service Worker registriert:', registration);
                })
                .catch(error => {
                    console.log('Service Worker Registrierung fehlgeschlagen:', error);
                });
        });
    }
</script>

</body>
</html>
