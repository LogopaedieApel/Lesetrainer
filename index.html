<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktiver Lese-Trainer</title>
    <style>
        /* CSS bleibt unverändert - hier zur Vollständigkeit gekürzt */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        #app-container { background-color: #ffffff; padding: 25px 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 700px; text-align: center; }
        h1, h2 { color: #333; }
        .view { display: none; }
        .view.active { display: block; }
        textarea { width: 95%; height: 150px; margin-bottom: 15px; padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 5px; }
        #progress-indicator { font-size: 0.9rem; color: #777; margin-bottom: 20px; }
        #current-reconstruction { min-height: 50px; border: 2px dashed #d0d0d0; border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 1.2rem; color: #333; font-weight: bold; letter-spacing: 1px; background-color: #fafafa; }
        #word-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        #feedback-message { margin-top: 15px; font-weight: bold; min-height: 24px; }
        #feedback-message.correct { color: #28a745; }
        #feedback-message.incorrect { color: #dc3545; }
        button { padding: 12px 20px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; background-color: #007bff; color: white; transition: background-color 0.2s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #e0e0e0; cursor: not-allowed; color: #999; }
        .word-button { background-color: #6c757d; }
        .word-button:hover:not(:disabled) { background-color: #5a6268; }
        #play-audio-button { background-color: #17a2b8; margin-right: 10px; }
        #play-audio-button:hover { background-color: #138496; }
        #next-sentence-button { background-color: #28a745; display: none; }
        #next-sentence-button:hover { background-color: #218838; }
    </style>
</head>
<body>

    <div id="app-container">
        <h1>Interaktiver Lese-Trainer</h1>

        <!-- HTML-Teil bleibt unverändert -->
        <div id="setup-view" class="view active">
            <h2>Schritt 1: Deine Sätze</h2>
            <p>Gib hier die Sätze ein, die du üben möchtest. Ein Satz pro Zeile.</p>
            <textarea id="sentence-input" placeholder="Die Katze schläft.
Der Hund bellt laut.
Die Sonne scheint heute hell."></textarea>
            <button id="start-button">Spiel starten</button>
        </div>

        <div id="game-view" class="view">
            <div id="progress-indicator">Satz 1 von 3</div>
            <p>Höre gut zu und baue den Satz nach.</p>
            <div id="current-reconstruction">&nbsp;</div>
            <div id="word-pool"></div>
            <div id="feedback-message"></div>
            <button id="play-audio-button">Satz vorlesen</button>
            <button id="next-sentence-button">Nächster Satz</button>
        </div>

        <div id="finish-view" class="view">
            <h2>Großartig!</h2>
            <p>Du hast alle Sätze erfolgreich geübt.</p>
            <button id="restart-button">Nochmal spielen</button>
        </div>
    </div>

    <script>
        // DOM-Elemente abrufen (unverändert)
        const setupView = document.getElementById('setup-view');
        const gameView = document.getElementById('game-view');
        const finishView = document.getElementById('finish-view');
        const sentenceInput = document.getElementById('sentence-input');
        const startButton = document.getElementById('start-button');
        const progressIndicator = document.getElementById('progress-indicator');
        const currentReconstruction = document.getElementById('current-reconstruction');
        const wordPool = document.getElementById('word-pool');
        const feedbackMessage = document.getElementById('feedback-message');
        const playAudioButton = document.getElementById('play-audio-button');
        const nextSentenceButton = document.getElementById('next-sentence-button');
        const restartButton = document.getElementById('restart-button');

        // Spielzustand (unverändert)
        let allSentences = [];
        let currentSentenceIndex = 0;
        let originalWords = [];
        let reconstructedWords = [];
        
        // NEU: Variable für die beste gefundene deutsche Stimme
        let germanVoice = null;

        // NEU: Funktion zum Laden und Auswählen der Stimmen
        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            // Wir suchen nach einer hochwertigen deutschen Stimme. "Google Deutsch" ist oft sehr gut.
            // Die Reihenfolge hier ist eine Prioritätenliste.
            const preferredVoices = [
                "Google Deutsch", 
                "Microsoft Hedda - German (Germany)", // Neuere Windows Stimme
                "Anna (de-DE)", // macOS Stimme
            ];

            // Finde die erste bevorzugte Stimme, die verfügbar ist
            for (const name of preferredVoices) {
                const foundVoice = voices.find(voice => voice.name === name && voice.lang === 'de-DE');
                if (foundVoice) {
                    germanVoice = foundVoice;
                    console.log("Bevorzugte Stimme gefunden:", germanVoice.name);
                    return;
                }
            }

            // Wenn keine bevorzugte Stimme gefunden wurde, nimm die erste verfügbare deutsche Stimme
            germanVoice = voices.find(voice => voice.lang === 'de-DE');
            if (germanVoice) {
                console.log("Fallback-Stimme gefunden:", germanVoice.name);
            } else {
                console.log("Keine deutsche Stimme gefunden.");
            }
        }

        // NEU: Die Stimmen werden oft asynchron geladen. Wir müssen auf das 'voiceschanged'-Event warten.
        window.speechSynthesis.onvoiceschanged = loadVoices;
        // Rufe die Funktion auch einmal direkt auf, falls die Stimmen schon geladen sind.
        loadVoices();


        // Event Listener für die Buttons (unverändert)
        startButton.addEventListener('click', startGame);
        playAudioButton.addEventListener('click', playCurrentSentence);
        nextSentenceButton.addEventListener('click', loadNextSentence);
        restartButton.addEventListener('click', () => location.reload()); 
        
        // --- Die restlichen Funktionen bleiben fast gleich, nur playCurrentSentence wird angepasst ---
        
        function startGame() {
            const inputText = sentenceInput.value.trim();
            if (inputText === '') {
                alert('Bitte gib mindestens einen Satz ein.');
                return;
            }
            allSentences = inputText.split('\n').filter(s => s.trim() !== '');
            if (allSentences.length === 0) {
                alert('Keine gültigen Sätze gefunden.');
                return;
            }
            currentSentenceIndex = 0;
            setupView.classList.remove('active');
            gameView.classList.add('active');
            loadSentence(currentSentenceIndex);
        }

        function loadSentence(index) {
            if (index >= allSentences.length) {
                showFinishScreen();
                return;
            }
            reconstructedWords = [];
            feedbackMessage.textContent = '';
            feedbackMessage.className = '';
            nextSentenceButton.style.display = 'none';
            updateReconstructionDisplay();
            progressIndicator.textContent = `Satz ${index + 1} von ${allSentences.length}`;
            const currentSentence = allSentences[index];
            originalWords = currentSentence.replace(/[.,!?;]$/, '').split(' ');
            const shuffledWords = [...originalWords].sort(() => Math.random() - 0.5);
            displayWords(shuffledWords);
            playCurrentSentence();
        }

        function displayWords(words) {
            wordPool.innerHTML = '';
            words.forEach(word => {
                const button = document.createElement('button');
                button.textContent = word;
                button.classList.add('word-button');
                button.addEventListener('click', () => handleWordClick(word, button));
                wordPool.appendChild(button);
            });
        }

        function handleWordClick(word, button) {
            button.disabled = true;
            reconstructedWords.push(word);
            updateReconstructionDisplay();
            checkSentence();
        }

        function updateReconstructionDisplay() {
            if (reconstructedWords.length === 0) {
                currentReconstruction.innerHTML = '&nbsp;';
            } else {
                currentReconstruction.textContent = reconstructedWords.join(' ');
            }
        }

        function checkSentence() {
            const reconstructed = reconstructedWords.join(' ');
            const original = originalWords.slice(0, reconstructedWords.length).join(' ');
            if (reconstructed !== original) {
                feedbackMessage.textContent = 'Das war nicht richtig. Versuch es nochmal!';
                feedbackMessage.className = 'incorrect';
                setTimeout(() => {
                    reconstructedWords = [];
                    updateReconstructionDisplay();
                    feedbackMessage.textContent = '';
                    document.querySelectorAll('.word-button').forEach(btn => btn.disabled = false);
                }, 1500);
            } else if (reconstructedWords.length === originalWords.length) {
                feedbackMessage.textContent = 'Super, das ist richtig!';
                feedbackMessage.className = 'correct';
                nextSentenceButton.style.display = 'inline-block';
            }
        }

        function loadNextSentence() {
            currentSentenceIndex++;
            loadSentence(currentSentenceIndex);
        }

        function showFinishScreen() {
            gameView.classList.remove('active');
            finishView.classList.add('active');
        }

        // VERBESSERTE Funktion, um einen Satz vorzulesen
        function playCurrentSentence() {
            if ('speechSynthesis' in window && allSentences.length > 0) {
                const utterance = new SpeechSynthesisUtterance(allSentences[currentSentenceIndex]);
                utterance.lang = 'de-DE';
                utterance.rate = 0.9;
                
                // NEU: Weise die beste gefundene Stimme zu
                if (germanVoice) {
                    utterance.voice = germanVoice;
                } else {
                    console.warn("Warnung: Es konnte keine spezifische deutsche Stimme zugewiesen werden. Nutze Browser-Standard.");
                }

                // Stoppt eventuell laufende Sprachausgaben, bevor eine neue gestartet wird
                window.speechSynthesis.cancel(); 
                window.speechSynthesis.speak(utterance);
            } else {
                alert('Dein Browser unterstützt leider keine Sprachausgabe.');
            }
        }
    </script>
</body>
</html>
