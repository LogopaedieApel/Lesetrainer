<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktiver Lese-Trainer</title>
    <style>
        /* CSS bleibt unverändert - hier zur Vollständigkeit gekürzt */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        #app-container { background-color: #ffffff; padding: 25px 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 700px; text-align: center; }
        h1, h2 { color: #333; }
        .view { display: none; }
        .view.active { display: block; }
        #list-selection-container { margin-top: 20px; text-align: left; }
        .list-item { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px 20px; margin-bottom: 12px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .list-item:hover { background-color: #e9ecef; border-color: #ced4da; }
        .list-item h3 { margin: 0 0 5px 0; color: #007bff; }
        .list-item p { margin: 0; color: #6c757d; font-size: 0.9rem; }
        #loading-indicator { font-style: italic; color: #666; }
        #progress-indicator { font-size: 0.9rem; color: #777; margin-bottom: 20px; }
        #current-reconstruction { min-height: 50px; border: 2px dashed #d0d0d0; border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 1.2rem; color: #333; font-weight: bold; letter-spacing: 1px; background-color: #fafafa; }
        #word-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        #feedback-message { margin-top: 15px; font-weight: bold; min-height: 24px; }
        #feedback-message.correct { color: #28a745; }
        #feedback-message.incorrect { color: #dc3545; }
        button { padding: 12px 20px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; background-color: #007bff; color: white; transition: background-color 0.2s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #e0e0e0; cursor: not-allowed; color: #999; }
        .word-button { background-color: #6c757d; }
        .word-button:hover:not(:disabled) { background-color: #5a6268; }
        #play-audio-button { background-color: #17a2b8; margin-right: 10px; }
        #next-sentence-button { background-color: #28a745; display: none; }
        .menu-button { background-color: #6c757d; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="app-container">
        <h1>Interaktiver Lese-Trainer</h1>

        <!-- Start-Ansicht -->
        <div id="start-view" class="view active">
            <h2>Wähle eine Satzliste zum Üben</h2>
            <div id="list-selection-container">
                <p id="loading-indicator">Lade Listen...</p>
            </div>
        </div>

        <!-- Spiel-Ansicht -->
        <div id="game-view" class="view">
            <div id="progress-indicator">Satz 1 von X</div>
            <p>Höre gut zu und baue den Satz nach.</p>
            <div id="current-reconstruction">&nbsp;</div>
            <div id="word-pool"></div>
            <div id="feedback-message"></div>
            <button id="play-audio-button">Satz vorlesen</button>
            <button id="next-sentence-button">Nächster Satz</button>
            <br>
            <button id="back-to-menu-button-game" class="menu-button">Zurück zum Menü</button>
        </div>

        <!-- Finish-Ansicht -->
        <div id="finish-view" class="view">
            <h2>Großartig!</h2>
            <p>Du hast alle Sätze erfolgreich geübt.</p>
            <button id="restart-button">Dieselbe Liste nochmal</button>
            <button id="back-to-menu-button-finish" class="menu-button">Andere Liste wählen</button>
        </div>
    </div>

    <script>
        // DOM-Elemente
        const startView = document.getElementById('start-view');
        const gameView = document.getElementById('game-view');
        const finishView = document.getElementById('finish-view');
        const listSelectionContainer = document.getElementById('list-selection-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const progressIndicator = document.getElementById('progress-indicator');
        const currentReconstruction = document.getElementById('current-reconstruction');
        const wordPool = document.getElementById('word-pool');
        const feedbackMessage = document.getElementById('feedback-message');
        const playAudioButton = document.getElementById('play-audio-button');
        const nextSentenceButton = document.getElementById('next-sentence-button');
        const restartButton = document.getElementById('restart-button');
        const backToMenuGameBtn = document.getElementById('back-to-menu-button-game');
        const backToMenuFinishBtn = document.getElementById('back-to-menu-button-finish');
        
        // Spielzustand
        let allSentences = [];
        let currentSentenceIndex = 0;
        let originalWords = [];
        let reconstructedWords = [];
        let germanVoice = null;

        // --- Initialisierung und Navigation ---

        // Event Listener
        document.addEventListener('DOMContentLoaded', loadMasterList);
        backToMenuGameBtn.addEventListener('click', showStartView);
        backToMenuFinishBtn.addEventListener('click', showStartView);
        restartButton.addEventListener('click', () => startGame(allSentences));

        // HIER IST DIE KORREKTUR: Die fehlenden Event Listener für die Spiel-Buttons
        playAudioButton.addEventListener('click', playCurrentSentence);
        nextSentenceButton.addEventListener('click', loadNextSentence); // DIESE ZEILE HAT GEFEHLT


        function showView(viewToShow) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            viewToShow.classList.add('active');
        }

        function showStartView() {
            allSentences = [];
            currentSentenceIndex = 0;
            showView(startView);
        }

        // --- Laden der Daten ---

        async function loadMasterList() {
            try {
                const response = await fetch('master.json');
                if (!response.ok) throw new Error('Netzwerkfehler beim Laden der master.json');
                const data = await response.json();
                populateListSelection(data.lists);
            } catch (error) {
                console.error("Fehler:", error);
                loadingIndicator.textContent = 'Fehler beim Laden der Satzlisten.';
            }
        }

        function populateListSelection(lists) {
            listSelectionContainer.innerHTML = '';
            lists.forEach(list => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.dataset.file = list.file;
                item.innerHTML = `<h3>${list.title}</h3><p>${list.description}</p>`;
                item.addEventListener('click', async () => {
                    try {
                        const response = await fetch(list.file);
                        if (!response.ok) throw new Error(`Datei ${list.file} nicht gefunden.`);
                        const sentenceData = await response.json();
                        startGame(sentenceData.sentences);
                    } catch (error) {
                        alert(`Fehler beim Laden der Satzliste: ${error.message}`);
                    }
                });
                listSelectionContainer.appendChild(item);
            });
        }

        // --- Spiellogik (unverändert) ---
        
        function startGame(sentences) {
            if (!sentences || sentences.length === 0) {
                alert('Diese Liste enthält keine Sätze.');
                return;
            }
            allSentences = sentences;
            currentSentenceIndex = 0;
            showView(gameView);
            loadSentence(currentSentenceIndex);
        }

        function loadSentence(index) {
            if (index >= allSentences.length) {
                showView(finishView);
                return;
            }
            reconstructedWords = [];
            feedbackMessage.textContent = '';
            feedbackMessage.className = '';
            nextSentenceButton.style.display = 'none';
            updateReconstructionDisplay();
            progressIndicator.textContent = `Satz ${index + 1} von ${allSentences.length}`;
            const currentSentence = allSentences[index];
            originalWords = currentSentence.replace(/[.,!?;]$/, '').split(' ');
            const shuffledWords = [...originalWords].sort(() => Math.random() - 0.5);
            displayWords(shuffledWords);
            playCurrentSentence();
        }
        
        function displayWords(words) { wordPool.innerHTML = ''; words.forEach(word => { const button = document.createElement('button'); button.textContent = word; button.classList.add('word-button'); button.addEventListener('click', () => handleWordClick(word, button)); wordPool.appendChild(button); }); }
        function handleWordClick(word, button) { button.disabled = true; reconstructedWords.push(word); updateReconstructionDisplay(); checkSentence(); }
        function updateReconstructionDisplay() { currentReconstruction.textContent = reconstructedWords.length > 0 ? reconstructedWords.join(' ') : '\u00A0'; }
        function checkSentence() { const reconstructed = reconstructedWords.join(' '); const original = originalWords.slice(0, reconstructedWords.length).join(' '); if (reconstructed !== original) { feedbackMessage.textContent = 'Das war nicht richtig. Versuch es nochmal!'; feedbackMessage.className = 'incorrect'; setTimeout(() => { reconstructedWords = []; updateReconstructionDisplay(); feedbackMessage.textContent = ''; document.querySelectorAll('.word-button').forEach(btn => btn.disabled = false); }, 1500); } else if (reconstructedWords.length === originalWords.length) { feedbackMessage.textContent = 'Super, das ist richtig!'; feedbackMessage.className = 'correct'; nextSentenceButton.style.display = 'inline-block'; } }
        function loadNextSentence() { currentSentenceIndex++; loadSentence(currentSentenceIndex); }

        // --- Sprachausgabe (unverändert) ---
        
        window.speechSynthesis.onvoiceschanged = () => {
            const voices = window.speechSynthesis.getVoices();
            germanVoice = voices.find(voice => voice.name === 'Google Deutsch' && voice.lang === 'de-DE') || voices.find(voice => voice.lang === 'de-DE');
        };
        function playCurrentSentence() { if ('speechSynthesis' in window && allSentences.length > 0) { const utterance = new SpeechSynthesisUtterance(allSentences[currentSentenceIndex]); utterance.lang = 'de-DE'; utterance.rate = 0.9; if (germanVoice) utterance.voice = germanVoice; window.speechSynthesis.cancel(); window.speechSynthesis.speak(utterance); } }
    </script>
</body>
</html>
