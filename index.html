<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1, maximum-scale=1, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lese-Trainer">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">


    <title>Interaktiver Lese-Trainer</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            font-family: 'Lexend', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            padding-top: calc(20px + env(safe-area-inset-top, 0px));
            padding-right: calc(20px + env(safe-area-inset-right, 0px));
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
            padding-left: calc(20px + env(safe-area-inset-left, 0px));
        }
        body.start-view-active { align-items: flex-start; overflow-y: auto; touch-action: pan-y; }
        body.game-view-active, body.finish-view-active { align-items: center; overflow: hidden; touch-action: none; }
        #app-container { background-color: #ffffff; padding: 25px 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px; text-align: center; transition: max-width 0.3s ease, min-height 0.3s ease; }
        body.fullscreen-mode { padding: 0; }
        #app-container.two-player-mode { max-width: 100%; height: 100%; border-radius: 0; box-shadow: none; display: flex; flex-direction: column; }
        h1, h2, h3 { color: #333; }
        .view { display: none; }
        .view.active { display: block; }
        #game-view.active { display: flex; flex-direction: column; flex-grow: 1; }
        #loading-indicator { font-style: italic; color: #666; }
        button { font-family: inherit; padding: 12px 20px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; background-color: #007bff; color: white; transition: background-color 0.2s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #e0e0e0; cursor: not-allowed; color: #999; }
        .menu-button { background-color: #6c757d; margin-top: 0; }
        .single-player-game { text-align: center; }
        #progress-indicator { font-size: 0.9rem; color: #777; margin-bottom: 20px; }
        #current-reconstruction { min-height: 50px; border: 2px dashed #d0d0d0; border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 1.2rem; color: #333; font-weight: bold; letter-spacing: 1px; background-color: #fafafa; }
        #word-pool { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; min-height: 100px; }
        #feedback-message { margin-top: 15px; font-weight: bold; min-height: 24px; }
        #feedback-message.correct { color: #28a745; }
        #feedback-message.incorrect { color: #dc3545; }
        @keyframes flash-green { 0% { background-color: #fafafa; border-color: #d0d0d0; } 50% { background-color: #d4edda; border-color: #28a745; } 100% { background-color: #fafafa; border-color: #d0d0d0; } }
        .player-area .current-reconstruction { background-color: #fff; }
        @keyframes flash-green-player { 0% { background-color: #fff; border-color: #d0d0d0; } 50% { background-color: #d4edda; border-color: #28a745; } 100% { background-color: #fff; border-color: #d0d0d0; } }
        .flash-success { animation: flash-green 0.5s ease-out; }
        .player-area .flash-success { animation-name: flash-green-player; }
        .word-button { background-color: #6c757d; }
        .word-button:hover:not(:disabled) { background-color: #5a6268; }
        #play-audio-button { background-color: #17a2b8; }
        #next-sentence-button { background-color: #28a745; display: none; }
        .settings-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; text-align: left; }
        #two-player-container { display: flex; flex-direction: column; width: 100%; flex-grow: 1; }
        .player-area { border: 2px solid #007bff; border-radius: 10px; padding: 20px; background-color: #f8f9fa; flex: 1; display: flex; flex-direction: column; justify-content: space-around; box-sizing: border-box; touch-action: none; }
        #player2-area { border-color: #dc3545; transform: rotate(180deg); }
        .player-area h2 { margin-top: 0; }
        .player-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .score { font-size: 1.2rem; }
        .player-area .progress-indicator { margin: 0; }
        .player-area .current-reconstruction { font-size: 1.1rem; min-height: 45px; padding: 12px; border: 2px dashed #d0d0d0; border-radius: 8px; background-color: #fff; }
        .player-area .word-pool { min-height: 80px; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .player-area .feedback-message { min-height: 20px; font-size: 0.9rem; }
        .play-audio-button-player { background-color: #17a2b8; align-self: center; margin-top: 10px; }
        #central-controls { display: flex; justify-content: center; align-items: center; gap: 20px; padding: 10px 0; background-color: #e9ecef; flex-shrink: 0; }
        .game-mode-selection label { display: inline-block; margin: 0 10px; font-size: 1.1rem; cursor: pointer; }
        #rounds-container { margin-top: 15px; display: none; }
        #rounds-container label { margin-right: 10px; }
        #rounds-input { width: 60px; padding: 5px; font-size: 1rem; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #2196F3; }
        input:focus + .slider { box-shadow: 0 0 1px #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        #error-type-selection label { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-size: 0.95rem; color: #444; }
        #error-type-selection input[type="radio"] { margin: 0; }
        #error-frequency-container { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        #error-frequency-slider { width: calc(100% - 70px); margin-right: 10px; vertical-align: middle; }
        #error-frequency-value { font-weight: bold; color: #007bff; display: inline-block; width: 20px; text-align: right; vertical-align: middle; }
        #multi-list-selection-container { text-align: left; }
        #list-selector-ui { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #list-selector-ui select { flex: 1 1 180px; padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 5px; min-width: 150px;}
        #add-list-button { padding: 10px 15px; font-size: 1.2rem; background-color: #28a745; line-height: 1; flex-shrink: 0;}
        #selected-lists-container { margin-top: 15px; display: flex; flex-direction: column; gap: 8px; }
        .selected-list-item { background-color: #e9ecef; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .remove-list-button { background-color: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-size: 1rem; line-height: 25px; padding: 0; cursor: pointer; flex-shrink: 0;}
        #start-game-button { width: 100%; padding: 15px; font-size: 1.2rem; margin-top: 30px; }

        .flash-word-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            min-height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .player-area .flash-word-display {
             font-size: 2rem;
             min-height: 100px;
        }
        #flash-word-settings select {
            padding: 8px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-left: 10px;
        }
        .repeat-button {
            background-color: #17a2b8;
            margin: -10px 0 15px 0;
        }
        .repeat-button:hover:not(:disabled) {
            background-color: #138496;
        }
        
        @media (min-width: 800px) {
            #settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px 40px; align-items: start; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
            #settings-grid .settings-section { margin-top: 0; padding-top: 0; border-top: none; }
            #settings-grid .settings-section:nth-child(4) {
                grid-column: 1 / -1;
            }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <h1>Interaktiver Lese-Trainer</h1>

        <div id="start-view" class="view active">
            <h2>Wähle eine oder mehrere Listen zum Üben</h2>

            <div id="multi-list-selection-container" class="settings-section">
                <p id="loading-indicator">Lade Listen...</p>
                <div id="list-selector-ui" style="display: none;">
                    <select id="category-select"></select>
                    <select id="list-select"></select>
                    <button id="add-list-button">+</button>
                </div>
                <div id="selected-lists-container"></div>
            </div>

            <button id="start-game-button">Spiel starten</button>

            <div id="settings-grid">
                <div class="settings-section">
                    <h3>Spielmodus</h3>
                    <div class="game-mode-selection">
                        <label><input type="radio" name="gameMode" value="single" checked> Einzelspieler</label>
                        <label><input type="radio" name="gameMode" value="two-player"> Zwei Spieler</label>
                    </div>
                    <div style="margin-top: 15px;">
                        <label class="switch">
                            <input type="checkbox" id="auto-continue-toggle">
                            <span class="slider round"></span>
                        </label>
                        <label for="auto-continue-toggle" style="margin-left: 10px; font-weight: bold; vertical-align: middle;">Automatisch weiter</label>
                    </div>
                    <div id="rounds-container">
                        <label for="rounds-input">Anzahl der Sätze:</label>
                        <input type="number" id="rounds-input" value="5" min="1" max="50">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Präsentationsmodus</h3>
                    <div class="game-mode-selection">
                         <label><input type="radio" name="presentationMode" value="audio" checked> Satz vorlesen</label>
                         <label><input type="radio" name="presentationMode" value="flash"> Blitzlesen</label>
                    </div>
                    <div id="flash-word-settings" style="display: none; margin-top: 15px;">
                        <label for="flash-word-duration">Anzeigedauer:</label>
                        <select id="flash-word-duration"></select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Zufällige Reihenfolge</h3>
                    <label class="switch">
                        <input type="checkbox" id="random-order-toggle" checked>
                        <span class="slider round"></span>
                    </label>
                    <label for="random-order-toggle" style="margin-left: 10px; font-weight: bold; vertical-align: middle;">Sätze randomisieren</label>
                </div>

                <div class="settings-section">
                    <h3>Fehler-Modus (Optional)</h3>
                    <label class="switch">
                        <input type="checkbox" id="error-mode-toggle">
                        <span class="slider round"></span>
                    </label>
                    <label for="error-mode-toggle" style="margin-left: 10px; font-weight: bold; vertical-align: middle;">Fehler aktivieren</label>
                    <div id="error-type-selection" style="display: none; margin-top: 15px;">
                        <h4>Fehlerart auswählen:</h4>
                         <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label><input type="radio" name="errorType" value="missingLetter" checked> Buchstabe fehlt</label>
                            <label><input type="radio" name="errorType" value="swappedLetters"> Buchstaben vertauscht</label>
                            <label><input type="radio" name="errorType" value="replacedLetter"> Falscher Buchstabe</label>
                            <label><input type="radio" name="errorType" value="duplicatedLetters"> Doppelte Buchstaben</label>
                            <label><input type="radio" name="errorType" value="phoneticallySimilar"> Phonetisch ähnliche Buchstaben</label>
                            <label><input type="radio" name="errorType" value="capitalization"> Groß-/Kleinschreibung</label>
                        </div>
                        <div id="error-frequency-container">
                            <h4>Fehlerhäufigkeit pro Satz:</h4>
                            <input type="range" id="error-frequency-slider" min="1" max="5" value="1">
                            <span id="error-frequency-value">1</span> Fehler
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="game-view" class="view"></div>
        <div id="finish-view" class="view"></div>
    </div>

<script>
    // --- DOM ELEMENTE ---
    const appContainer = document.getElementById('app-container');
    const mainTitle = document.querySelector('#app-container > h1');
    const startView = document.getElementById('start-view');
    const gameView = document.getElementById('game-view');
    const finishView = document.getElementById('finish-view');
    const loadingIndicator = document.getElementById('loading-indicator');
    const listSelectorUi = document.getElementById('list-selector-ui');
    const categorySelect = document.getElementById('category-select');
    const listSelect = document.getElementById('list-select');
    const addListButton = document.getElementById('add-list-button');
    const selectedListsContainer = document.getElementById('selected-lists-container');
    const startGameButton = document.getElementById('start-game-button');
    const gameModeRadios = document.querySelectorAll('input[name="gameMode"]');
    const roundsContainer = document.getElementById('rounds-container');
    const roundsInput = document.getElementById('rounds-input');
    const randomOrderToggle = document.getElementById('random-order-toggle');
    const errorModeToggle = document.getElementById('error-mode-toggle');
    const errorTypeSelection = document.getElementById('error-type-selection');
    const errorFrequencySlider = document.getElementById('error-frequency-slider');
    const errorFrequencyValueSpan = document.getElementById('error-frequency-value');
    const autoContinueToggle = document.getElementById('auto-continue-toggle');
    const presentationModeRadios = document.querySelectorAll('input[name="presentationMode"]');
    const flashWordSettings = document.getElementById('flash-word-settings');
    const flashWordDurationSelect = document.getElementById('flash-word-duration');

    // --- GLOBALE VARIABLEN ---
    let allSentences = [];
    let currentSentenceIndex = 0;
    let originalWords = [];
    let reconstructedWords = [];
    let germanVoice = null;
    let gameMode = 'single';
    let totalRounds = 5;
    let randomOrderEnabled = true;
    let errorModeEnabled = false;
    let selectedErrorType = 'missingLetter';
    let selectedErrorFrequency = 1;
    let player1, player2;
    let roundOver = false;
    let autoContinueEnabled = false;
    let categorizedLists = {};
    let selectedLists = [];
    let presentationMode = 'audio';
    let flashWordDuration = 1000;
    let currentFlashSequenceId = 0; // Eindeutige ID für jede Blitz-Sequenz

    // --- INITIALISIERUNG ---
    document.addEventListener('DOMContentLoaded', () => {
        loadMasterList();
        setupEventListeners();
        populateFlashDurations();
        errorFrequencyValueSpan.textContent = errorFrequencySlider.value;
        showView(startView);
    });

    function setupEventListeners() {
        categorySelect.addEventListener('change', () => populateListsForCategory(categorySelect.value));
        addListButton.addEventListener('click', addSelectedList);
        startGameButton.addEventListener('click', startGame);
        gameModeRadios.forEach(radio => radio.addEventListener('change', (e) => {
            gameMode = e.target.value;
            roundsContainer.style.display = gameMode === 'two-player' ? 'block' : 'none';
        }));
        randomOrderToggle.addEventListener('change', () => randomOrderEnabled = randomOrderToggle.checked);
        errorModeToggle.addEventListener('change', () => {
            errorModeEnabled = errorModeToggle.checked;
            errorTypeSelection.style.display = errorModeEnabled ? 'block' : 'none';
        });
        document.querySelectorAll('input[name="errorType"]').forEach(radio => radio.addEventListener('change', (e) => selectedErrorType = e.target.value));
        errorFrequencySlider.addEventListener('input', (e) => {
            selectedErrorFrequency = parseInt(e.target.value, 10);
            errorFrequencyValueSpan.textContent = selectedErrorFrequency;
        });
        autoContinueToggle.addEventListener('change', () => autoContinueEnabled = autoContinueToggle.checked);
        presentationModeRadios.forEach(radio => radio.addEventListener('change', (e) => {
            presentationMode = e.target.value;
            flashWordSettings.style.display = presentationMode === 'flash' ? 'block' : 'none';
        }));
        flashWordDurationSelect.addEventListener('change', (e) => {
            flashWordDuration = parseInt(e.target.value, 10);
        });
    }

    function populateFlashDurations() {
        for (let i = 1000; i >= 100; i -= 100) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `${i} ms`;
            flashWordDurationSelect.appendChild(option);
        }
        flashWordDuration = parseInt(flashWordDurationSelect.value, 10);
    }

    async function loadMasterList() {
        try {
            const response = await fetch('master.json');
            if (!response.ok) throw new Error('Netzwerkfehler');
            const data = await response.json();
            processAndCategorizeLists(data.lists);
            populateCategories();
            loadingIndicator.style.display = 'none';
            listSelectorUi.style.display = 'flex';
        } catch (error) {
            loadingIndicator.textContent = 'Fehler beim Laden der Satzlisten.';
        }
    }

    function processAndCategorizeLists(lists) {
        categorizedLists = lists.reduce((acc, list) => {
            const category = list.thema || 'Allgemein';
            if (!acc[category]) {
                acc[category] = [];
            }
            acc[category].push(list);
            return acc;
        }, {});
    }

    function populateCategories() {
        categorySelect.innerHTML = '';
        Object.keys(categorizedLists).forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
        populateListsForCategory(categorySelect.value);
    }

    function populateListsForCategory(category) {
        listSelect.innerHTML = '';
        categorizedLists[category].forEach(list => {
            const option = document.createElement('option');
            option.value = list.file;
            option.textContent = list.title;
            listSelect.appendChild(option);
        });
    }

    function addSelectedList() {
        const selectedFile = listSelect.value;
        const selectedTitle = listSelect.options[listSelect.selectedIndex].textContent;
        if (!selectedFile) return;

        const isAlreadyAdded = selectedLists.some(list => list.file === selectedFile);
        if (isAlreadyAdded) {
            alert('Diese Liste wurde bereits hinzugefügt.');
            return;
        }
        selectedLists.push({ file: selectedFile, title: selectedTitle });
        updateSelectedListsUI();
    }

    function updateSelectedListsUI() {
        selectedListsContainer.innerHTML = '';
        selectedLists.forEach((list, index) => {
            const item = document.createElement('div');
            item.className = 'selected-list-item';
            item.innerHTML = `<span>${list.title}</span>`;
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-list-button';
            removeBtn.innerHTML = '&times;';
            removeBtn.onclick = () => {
                selectedLists.splice(index, 1);
                updateSelectedListsUI();
            };
            item.appendChild(removeBtn);
            selectedListsContainer.appendChild(item);
        });
        startGameButton.disabled = selectedLists.length === 0;
    }

    async function startGame() {
        if (selectedLists.length === 0) {
            alert('Bitte wähle mindestens eine Liste aus.');
            return;
        }
        startGameButton.disabled = true;
        startGameButton.textContent = 'Lade Sätze...';

        try {
            const promises = selectedLists.map(list => fetch(list.file).then(res => res.json()));
            const results = await Promise.all(promises);
            const combinedSentences = results.flatMap(data => data.sentences);
            
            if (combinedSentences.length === 0) {
                alert('Die ausgewählten Listen enthalten keine Sätze.');
                showStartView();
                return;
            }
            initializeGame(combinedSentences);
        } catch (error) {
            alert('Ein Fehler ist beim Laden der Satzlisten aufgetreten.');
        } finally {
            startGameButton.disabled = false;
            startGameButton.textContent = 'Spiel starten';
        }
    }

    function initializeGame(sentences) {
        allSentences = randomOrderEnabled ? shuffleArray([...sentences]) : sentences;
        currentSentenceIndex = 0;
        if (gameMode === 'single') {
            document.body.classList.remove('fullscreen-mode');
            startSinglePlayerGame();
        } else {
            document.body.classList.add('fullscreen-mode');
            totalRounds = Math.min(parseInt(roundsInput.value, 10), allSentences.length);
            if (totalRounds < 1) {
                alert("Bitte eine gültige Rundenanzahl eingeben.");
                return;
            }
            allSentences = allSentences.slice(0, totalRounds);
            startTwoPlayerGame();
        }
    }
    
    function showView(viewToShow) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        viewToShow.classList.add('active');
        mainTitle.style.display = (viewToShow.id === 'start-view') ? 'block' : 'none';
        document.body.classList.remove('start-view-active', 'game-view-active', 'finish-view-active');
        if (viewToShow.id === 'start-view') document.body.classList.add('start-view-active');
        else if (viewToShow.id === 'game-view') document.body.classList.add('game-view-active');
        else if (viewToShow.id === 'finish-view') document.body.classList.add('finish-view-active');
    }

    function showStartView() {
        document.body.classList.remove('fullscreen-mode');
        appContainer.classList.remove('two-player-mode');
        gameMode = 'single';
        document.querySelector('input[name="gameMode"][value="single"]').checked = true;
        roundsContainer.style.display = 'none';
        randomOrderToggle.checked = true; randomOrderEnabled = true;
        errorModeToggle.checked = false; errorModeEnabled = false;
        errorTypeSelection.style.display = 'none';
        autoContinueToggle.checked = false; autoContinueEnabled = false;
        presentationMode = 'audio';
        document.querySelector('input[name="presentationMode"][value="audio"]').checked = true;
        flashWordSettings.style.display = 'none';
        allSentences = []; currentSentenceIndex = 0;
        selectedLists = [];
        updateSelectedListsUI();
        showView(startView);
    }

    // --- EINZELSPIELER-MODUS ---
    function startSinglePlayerGame() {
        appContainer.classList.remove('two-player-mode');
        gameView.innerHTML = `
            <div class="single-player-game">
                <div id="progress-indicator"></div>
                <div id="flash-word-display" class="flash-word-display"></div>
                <div id="game-area-content">
                    <button id="repeat-sequence-button" class="repeat-button" style="display: none;">Wiederholen</button>
                    <p>Höre gut zu und baue den Satz nach.</p>
                    <div id="current-reconstruction">&nbsp;</div>
                    <div id="word-pool"></div>
                    <div id="feedback-message"></div>
                    <button id="play-audio-button">Satz vorlesen</button>
                    <button id="next-sentence-button">Nächster Satz</button>
                </div>
                <br>
                <button id="back-to-menu-button-game" class="menu-button">Zurück zum Menü</button>
            </div>`;
        document.getElementById('play-audio-button').addEventListener('click', playCurrentSentence);
        document.getElementById('next-sentence-button').addEventListener('click', loadNextSinglePlayerSentence);
        document.getElementById('back-to-menu-button-game').addEventListener('click', showStartView);
        showView(gameView);
        loadSinglePlayerSentence(0);
    }

    async function loadSinglePlayerSentence(index) {
        if (index >= allSentences.length) {
            showSinglePlayerFinishView();
            return;
        }
        currentFlashSequenceId++; // Alle alten Sequenzen invalidieren

        const flashDisplay = document.getElementById('flash-word-display');
        const instructionText = document.querySelector('#game-area-content p');
        const currentReconstruction = document.getElementById('current-reconstruction');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextSentenceButton = document.getElementById('next-sentence-button');
        const wordPool = document.getElementById('word-pool');
        const playAudioButton = document.getElementById('play-audio-button');
        const repeatButton = document.getElementById('repeat-sequence-button');

        reconstructedWords = [];
        feedbackMessage.textContent = '';
        nextSentenceButton.style.display = 'none';
        wordPool.innerHTML = '';
        currentReconstruction.textContent = '\u00A0';
        document.getElementById('progress-indicator').textContent = `Satz ${index + 1} von ${allSentences.length}`;
        
        const currentSentence = allSentences[index];
        originalWords = currentSentence.replace(/[.,!?;]$/, '').split(' ');
        
        if (presentationMode === 'flash') {
            instructionText.textContent = 'Merke dir die Wörter und baue den Satz nach.';
            playAudioButton.style.display = 'none';
            repeatButton.style.display = 'inline-block';
            flashDisplay.style.display = 'flex';

            repeatButton.onclick = () => {
                reconstructedWords = [];
                feedbackMessage.textContent = '';
                currentReconstruction.textContent = '\u00A0';
                wordPool.innerHTML = '';
                startFlashWordSequence(originalWords, flashDisplay, wordPool);
            };
            
            await startFlashWordSequence(originalWords, flashDisplay, wordPool);

        } else {
            instructionText.textContent = 'Höre gut zu und baue den Satz nach.';
            playAudioButton.style.display = 'inline-block';
            repeatButton.style.display = 'none';
            flashDisplay.style.display = 'none';
            playCurrentSentence();
            displayWords(shuffleArray(generateWordPool(originalWords)), wordPool);
        }
    }
    
    function handleSinglePlayerWordClick(word, button) {
        button.disabled = true;
        reconstructedWords.push(word);
        document.getElementById('current-reconstruction').textContent = reconstructedWords.join(' ');
        checkSinglePlayerSentence();
    }

    function checkSinglePlayerSentence() {
        const feedbackMessage = document.getElementById('feedback-message');
        const reconstructed = reconstructedWords.join(' ');
        const original = originalWords.slice(0, reconstructedWords.length).join(' ');

        if (reconstructed !== original) {
            feedbackMessage.textContent = 'Das war nicht richtig. Versuch es nochmal!';
            feedbackMessage.className = 'incorrect';
            setTimeout(() => {
                reconstructedWords = [];
                document.getElementById('current-reconstruction').textContent = '\u00A0';
                feedbackMessage.textContent = '';
                document.querySelectorAll('#word-pool .word-button').forEach(btn => btn.disabled = false);
            }, 1500);
        } else if (reconstructedWords.length === originalWords.length) {
            currentFlashSequenceId++; // Stoppt jede noch laufende Sequenz
            feedbackMessage.textContent = 'Super, das ist richtig!';
            feedbackMessage.className = 'correct';
            document.querySelectorAll('#word-pool .word-button').forEach(btn => btn.disabled = true);
            document.getElementById('repeat-sequence-button').style.display = 'none';
            const reconstructionBox = document.getElementById('current-reconstruction');
            reconstructionBox.classList.add('flash-success');
            reconstructionBox.addEventListener('animationend', () => {
                reconstructionBox.classList.remove('flash-success');
            }, { once: true });

            if (autoContinueEnabled) {
                setTimeout(loadNextSinglePlayerSentence, 2000);
            } else {
                document.getElementById('next-sentence-button').style.display = 'inline-block';
            }
        }
    }

    function loadNextSinglePlayerSentence() {
        currentSentenceIndex++;
        loadSinglePlayerSentence(currentSentenceIndex);
    }

    function showSinglePlayerFinishView() {
        finishView.innerHTML = `<h2>Großartig!</h2><p>Du hast alle Sätze erfolgreich geübt.</p><button id="restart-button">Dieselbe Liste nochmal</button><button id="back-to-menu-button-finish" class="menu-button">Andere Liste wählen</button>`;
        document.getElementById('restart-button').addEventListener('click', () => initializeGame(allSentences));
        document.getElementById('back-to-menu-button-finish').addEventListener('click', showStartView);
        showView(finishView);
    }

    // --- ZWEI-SPIELER-MODUS ---
    function startTwoPlayerGame() {
        appContainer.classList.add('two-player-mode');
        gameView.innerHTML = `
        <div id="two-player-container">
            <div id="player2-area" class="player-area">
                <div class="player-header"><h2>Spieler 2</h2><div id="p2-score" class="score">Punkte: 0</div></div>
                <div id="p2-flash-word-display" class="flash-word-display"></div>
                <div id="p2-game-area-content">
                    <button id="p2-repeat-sequence-button" class="repeat-button" style="display:none; transform: rotate(180deg);">Wiederholen</button>
                    <div id="p2-progress" class="progress-indicator"></div>
                    <div id="p2-reconstruction" class="current-reconstruction">&nbsp;</div>
                    <div id="p2-word-pool" class="word-pool"></div>
                    <button id="p2-play-audio-button" class="play-audio-button-player">Satz vorlesen</button>
                    <div id="p2-feedback" class="feedback-message"></div>
                </div>
            </div>
            <div id="central-controls">
                <button id="next-sentence-button" style="display:none;">Nächster Satz</button>
                <button id="end-game-button" class="menu-button">Spiel beenden</button>
            </div>
            <div id="player1-area" class="player-area">
                <div class="player-header"><h2>Spieler 1</h2><div id="p1-score" class="score">Punkte: 0</div></div>
                 <div id="p1-flash-word-display" class="flash-word-display"></div>
                 <div id="p1-game-area-content">
                    <button id="p1-repeat-sequence-button" class="repeat-button" style="display:none;">Wiederholen</button>
                    <div id="p1-progress" class="progress-indicator"></div>
                    <div id="p1-reconstruction" class="current-reconstruction">&nbsp;</div>
                    <div id="p1-word-pool" class="word-pool"></div>
                    <button id="p1-play-audio-button" class="play-audio-button-player">Satz vorlesen</button>
                    <div id="p1-feedback" class="feedback-message"></div>
                 </div>
            </div>
        </div>`;
        player1 = { id: 1, score: 0, reconstructedWords: [], scoreEl: document.getElementById('p1-score'), progressEl: document.getElementById('p1-progress'), reconstructionEl: document.getElementById('p1-reconstruction'), wordPoolEl: document.getElementById('p1-word-pool'), feedbackEl: document.getElementById('p1-feedback'), flashDisplayEl: document.getElementById('p1-flash-word-display'), repeatBtn: document.getElementById('p1-repeat-sequence-button') };
        player2 = { id: 2, score: 0, reconstructedWords: [], scoreEl: document.getElementById('p2-score'), progressEl: document.getElementById('p2-progress'), reconstructionEl: document.getElementById('p2-reconstruction'), wordPoolEl: document.getElementById('p2-word-pool'), feedbackEl: document.getElementById('p2-feedback'), flashDisplayEl: document.getElementById('p2-flash-word-display'), repeatBtn: document.getElementById('p2-repeat-sequence-button') };
        document.getElementById('p1-play-audio-button').addEventListener('click', playCurrentSentence);
        document.getElementById('p2-play-audio-button').addEventListener('click', playCurrentSentence);
        document.getElementById('next-sentence-button').addEventListener('click', loadNextTwoPlayerSentence);
        document.getElementById('end-game-button').addEventListener('click', showStartView);
        showView(gameView);
        loadTwoPlayerSentence(0);
    }
    
    async function loadTwoPlayerSentence(index) {
        if (index >= allSentences.length) {
            showTwoPlayerFinishView();
            return;
        }
        roundOver = false;
        currentFlashSequenceId++; // Alle alten Sequenzen invalidieren

        document.getElementById('next-sentence-button').style.display = 'none';
        const p1PlayAudio = document.getElementById('p1-play-audio-button');
        const p2PlayAudio = document.getElementById('p2-play-audio-button');

        [player1, player2].forEach(p => {
            p.reconstructedWords = [];
            p.reconstructionEl.textContent = '\u00A0';
            p.feedbackEl.textContent = '';
            p.progressEl.textContent = `Satz ${index + 1} von ${allSentences.length}`;
            p.wordPoolEl.innerHTML = '';
        });

        const currentSentence = allSentences[index];
        originalWords = currentSentence.replace(/[.,!?;]$/, '').split(' ');
        
        if (presentationMode === 'flash') {
            [p1PlayAudio, p2PlayAudio].forEach(btn => btn.style.display = 'none');
            [player1, player2].forEach(p => {
                p.repeatBtn.style.display = 'inline-block';
                p.flashDisplayEl.style.display = 'flex';
            });
            
            const repeatHandler = () => {
                if (roundOver) return;
                [player1, player2].forEach(p => {
                    p.reconstructedWords = [];
                    p.reconstructionEl.textContent = '\u00A0';
                    p.feedbackEl.textContent = '';
                    p.wordPoolEl.innerHTML = '';
                });
                startFlashWordSequence(originalWords, player1.flashDisplayEl, player1.wordPoolEl);
                startFlashWordSequence(originalWords, player2.flashDisplayEl, player2.wordPoolEl);
            };
            player1.repeatBtn.onclick = repeatHandler;
            player2.repeatBtn.onclick = repeatHandler;

            await Promise.all([
                startFlashWordSequence(originalWords, player1.flashDisplayEl, player1.wordPoolEl),
                startFlashWordSequence(originalWords, player2.flashDisplayEl, player2.wordPoolEl)
            ]);
        } else {
             [p1PlayAudio, p2PlayAudio].forEach(btn => btn.style.display = 'block');
             [player1, player2].forEach(p => {
                p.repeatBtn.style.display = 'none';
                p.flashDisplayEl.style.display = 'none';
             });
             playCurrentSentence();
             const wordsForPool = generateWordPool(originalWords);
             const shuffledWords = shuffleArray(wordsForPool);
             displayWords(shuffledWords, player1.wordPoolEl, player1);
             displayWords(shuffledWords, player2.wordPoolEl, player2);
        }
    }

    function handleTwoPlayerWordClick(word, button, player) {
        if (roundOver) return;
        button.disabled = true;
        player.reconstructedWords.push(word);
        player.reconstructionEl.textContent = player.reconstructedWords.join(' ');
        checkTwoPlayerSentence(player);
    }

    function checkTwoPlayerSentence(player) {
        if (roundOver) return;
        const reconstructed = player.reconstructedWords.join(' ');
        const original = originalWords.slice(0, player.reconstructedWords.length).join(' ');
        if (reconstructed !== original) {
            player.feedbackEl.textContent = 'Falsch!';
            player.feedbackEl.className = 'feedback-message incorrect';
            const playerButtons = player.wordPoolEl.querySelectorAll('.word-button');
            setTimeout(() => {
                if (!roundOver) { 
                    player.reconstructedWords = [];
                    player.reconstructionEl.textContent = '\u00A0';
                    player.feedbackEl.textContent = '';
                    playerButtons.forEach(btn => btn.disabled = false);
                }
            }, 1000);
        } else if (player.reconstructedWords.length === originalWords.length) {
            roundOver = true; 
            currentFlashSequenceId++; // Stoppt jede noch laufende Sequenz
            [player1, player2].forEach(p => p.repeatBtn.style.display = 'none');
            const winner = player;
            const loser = (player.id === 1) ? player2 : player1;
            const roundPoints = originalWords.length;
            winner.score += roundPoints;
            winner.scoreEl.textContent = `Punkte: ${winner.score}`;
            winner.feedbackEl.textContent = `Runde gewonnen! +${roundPoints} Punkte`;
            winner.feedbackEl.className = 'feedback-message correct';
            let loserPoints = 0;
            for (let i = 0; i < loser.reconstructedWords.length; i++) {
                if (loser.reconstructedWords[i] === originalWords[i]) {
                    loserPoints++;
                }
            }
            loser.score += loserPoints;
            loser.scoreEl.textContent = `Punkte: ${loser.score}`;
            loser.feedbackEl.textContent = `+${loserPoints} Punkte für richtige Wörter`;
            loser.feedbackEl.className = 'feedback-message';
            document.querySelectorAll('.word-button').forEach(btn => btn.disabled = true);
            winner.reconstructionEl.classList.add('flash-success');
            winner.reconstructionEl.addEventListener('animationend', () => {
                winner.reconstructionEl.classList.remove('flash-success');
            }, { once: true });
            if (autoContinueEnabled) {
                setTimeout(loadNextTwoPlayerSentence, 2000);
            } else {
                document.getElementById('next-sentence-button').style.display = 'inline-block';
            }
        }
    }

    function loadNextTwoPlayerSentence() {
        currentSentenceIndex++;
        loadTwoPlayerSentence(currentSentenceIndex);
    }

    function showTwoPlayerFinishView() {
        let winnerText = '';
        if (player1.score > player2.score) {
            winnerText = 'Spieler 1 hat gewonnen!';
        } else if (player2.score > player1.score) {
            winnerText = 'Spieler 2 hat gewonnen!';
        } else {
            winnerText = 'Unentschieden!';
        }
        finishView.innerHTML = `<h2>Spiel beendet!</h2><h3>${winnerText}</h3><p style="font-size: 1.2rem; margin: 10px 0;">Spieler 1: <strong>${player1.score}</strong> Punkte</p><p style="font-size: 1.2rem; margin: 10px 0;">Spieler 2: <strong>${player2.score}</strong> Punkte</p><button id="back-to-menu-button-finish" class="menu-button">Zurück zum Hauptmenü</button>`;
        document.getElementById('back-to-menu-button-finish').addEventListener('click', showStartView);
        showView(finishView);
    }
    
    // --- HILFSFUNKTIONEN ---
    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ==========================================================
    // ===== HIER IST DIE ROBUSTE, ABBRECHBARE FUNKTION (V2) ====
    // ==========================================================
    async function startFlashWordSequence(words, displayEl, wordPoolEl) {
        // Jede neue Sequenz erhöht den globalen Zähler und merkt sich ihre eigene ID.
        const mySequenceId = ++currentFlashSequenceId;

        displayEl.textContent = '';
        if (wordPoolEl) wordPoolEl.innerHTML = ''; // Leert den Wort-Pool zu Beginn

        await delay(200);

        for (const word of words) {
            // PRÜFUNG 1: Ist meine ID noch die aktuellste? Wenn nicht -> Abbruch.
            if (mySequenceId !== currentFlashSequenceId) return;

            displayEl.textContent = word;
            await delay(flashWordDuration);

            // PRÜFUNG 2: Auch nach der Wartezeit noch einmal prüfen.
            if (mySequenceId !== currentFlashSequenceId) return;

            displayEl.textContent = '';
            await delay(150);
        }

        // Die Wörter zum Nachbauen nur anzeigen, wenn diese Sequenz nicht unterbrochen wurde.
        if (mySequenceId === currentFlashSequenceId) {
            if (wordPoolEl) {
                const wordPoolData = (gameMode === 'single') ? null : (displayEl.id.includes('p1') ? player1 : player2);
                displayWords(shuffleArray(generateWordPool(words)), wordPoolEl, wordPoolData);
            }
        }
    }
    
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function displayWords(words, targetElement, player = null) {
        if (!targetElement) return;
        targetElement.innerHTML = '';
        words.forEach(word => {
            const button = document.createElement('button');
            button.textContent = word;
            button.classList.add('word-button');
            const handleInteraction = (event) => {
                event.preventDefault();
                if (button.disabled) return;
                if (gameMode === 'single') {
                    handleSinglePlayerWordClick(word, button);
                } else { 
                    if (roundOver) return; 
                    handleTwoPlayerWordClick(word, button, player); 
                }
            };
            button.addEventListener('touchstart', handleInteraction, { passive: false });
            button.addEventListener('click', handleInteraction);
            targetElement.appendChild(button);
        });
    }

    function generateWordPool(correctWords) {
        let pool = [...correctWords];
        if (errorModeEnabled) {
            const numWords = correctWords.length;
            const numErrors = Math.min(selectedErrorFrequency, numWords);
            let errorIndices = new Set();
            while (errorIndices.size < numErrors) {
                errorIndices.add(Math.floor(Math.random() * numWords));
            }
            errorIndices.forEach(index => {
                const errorWord = generateError(correctWords[index], selectedErrorType);
                if (errorWord && errorWord !== correctWords[index]) {
                    pool.push(errorWord);
                }
            });
        }
        return pool;
    }

    function generateError(word, errorType) {
        if (word.length <= 1 && !['capitalization', 'replacedLetter', 'duplicatedLetters'].includes(errorType)) {return word;}
        let modifiedWord = word; let chars = word.split('');
        const preserveCase = (originalChar, newChar) => {if (!originalChar) return newChar; if (originalChar === originalChar.toUpperCase() && originalChar.match(/[A-ZÄÖÜ]/)) { return newChar.toUpperCase(); } return newChar.toLowerCase(); };
        switch (errorType) {
            case 'missingLetter': if (chars.length > 1) { const indexToRemove = Math.floor(Math.random() * chars.length); chars.splice(indexToRemove, 1); modifiedWord = chars.join(''); } break;
            case 'swappedLetters': if (chars.length > 1) { const index1 = Math.floor(Math.random() * (chars.length - 1)); const index2 = index1 + 1; [chars[index1], chars[index2]] = [chars[index2], chars[index1]]; modifiedWord = chars.join(''); } break;
            case 'replacedLetter': if (chars.length > 0) { const indexToReplace = Math.floor(Math.random() * chars.length); const originalChar = chars[indexToReplace].toLowerCase(); const alphabet = 'abcdefghijklmnopqrstuvwxyzäöüß'; let replacementChar = originalChar; while (replacementChar === originalChar) { replacementChar = alphabet[Math.floor(Math.random() * alphabet.length)]; } chars[indexToReplace] = preserveCase(chars[indexToReplace], replacementChar); modifiedWord = chars.join(''); } break;
            case 'duplicatedLetters': if (chars.length > 0) { const indexToDuplicate = Math.floor(Math.random() * chars.length); chars.splice(indexToDuplicate, 0, chars[indexToDuplicate]); modifiedWord = chars.join(''); } break;
            case 'phoneticallySimilar': const subs = {'b':'p','p':'b','d':'t','t':'d','g':'k','k':'g','f':'v','v':'f','s':'z','z':'s'}; let replaced = false; for (let i=0; i<chars.length; i++) { const charLower = chars[i].toLowerCase(); if (subs[charLower]) { chars[i] = preserveCase(chars[i], subs[charLower]); replaced=true; break; } } if(replaced) modifiedWord = chars.join(''); else modifiedWord = generateError(word, 'replacedLetter'); break;
            case 'capitalization': if (chars.length > 0 && chars[0].match(/[A-Za-zÄÖÜäöü]/)) { if (chars[0] === chars[0].toUpperCase()) { chars[0] = chars[0].toLowerCase(); } else { chars[0] = chars[0].toUpperCase(); } modifiedWord = chars.join(''); } break;
        }
        if (modifiedWord === word || modifiedWord === "") { if (word.length > 0 && errorType !== 'replacedLetter') { let fallbackWord = generateError(word, 'replacedLetter'); if (fallbackWord !== word) { return fallbackWord; } } return word; } return modifiedWord;
    }

    window.speechSynthesis.onvoiceschanged = () => {
        germanVoice = window.speechSynthesis.getVoices().find(v => v.lang === 'de-DE');
    };

    function playCurrentSentence() {
        if ('speechSynthesis' in window && allSentences.length > 0) {
            const utterance = new SpeechSynthesisUtterance(allSentences[currentSentenceIndex]);
            utterance.lang = 'de-DE';
            utterance.rate = 0.9;
            if (germanVoice) utterance.voice = germanVoice;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }
    }
</script>

</body>
</html>
